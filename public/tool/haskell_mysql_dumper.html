<!DOCTYPE html>
<!--[if lt IE 7]>       <html class="no-js ie6 oldie" lang="zh"> <![endif]-->
<!--[if IE 7]>          <html class="no-js ie7 oldie" lang="zh"> <![endif]-->
<!--[if IE 8]>          <html class="no-js ie8 oldie" lang="zh"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="zh">
<!--<![endif]-->
<head>
<title>MySQL导出CSV文件（Haskell实现） - docx文档生成工具</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="最简单的方式构建你的项目文档" />
<meta name="author" content="Ryan Liu">
<link rel="icon" href="../assets/img/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="../assets/css/style.min.css">
<style rel="stylesheet">h1 a.html-hidden, div a.html-hidden</style>
<!-- Mobile -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<!-- Docs -->
<a href="https://github.com/azhai/docx" target="_blank" id="github-ribbon" class="hidden-print">
    <img src="../assets/img/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
</a>
<div class="navbar navbar-fixed-top hidden-print">
    <div class="container-fluid">
        <a class="brand navbar-brand pull-left" href="../index.html">docx文档生成工具</a>
        <p class="navbar-text pull-right"> 使用多表存储提高规模伸缩性 – Matt Mullenweg </p>
    </div>
</div>

<div class="container-fluid fluid-height wrapper">
    <div class="row columns content">
        <div class="left-column article-tree col-sm-3 hidden-print">
        <!-- For Mobile -->
<div class="responsive-collapse">
    <button type="button" class="btn btn-sidebar" id="menu-spinner-button">
    <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
    </button>
</div>
<div id="sub-nav-collapse" class="sub-nav-collapse">
    <!-- Navigation -->
    <ul class="nav nav-list">
    <li>
<a href="../index.html">首页</a>
</li>
<li>
<a href="#" class="aj-nav folder">Deploy</a>
<ul class="nav nav-list">
<li>
<a href="../deploy/vim_config.html">VIM配置</a>
</li>
<li>
<a href="../deploy/nginx_case_insensitive.html">让Nginx对URL不区分大小写</a>
</li>
<li>
<a href="../deploy/rsync_config.html">Rsync配置与使用</a>
</li>
<li>
<a href="../deploy/install_postfix.html">安装Postfix邮件服务器</a>
</li>
<li>
<a href="../deploy/nginx_log_cookie.html">Nginx记录访问cookie到日志</a>
</li>
<li>
<a href="../deploy/linux_upstart.html">Linux新的守护进程方式upstart</a>
</li>
<li>
<a href="../deploy/nginx-http_base_auth.html">Nginx设置简单HTTP认证</a>
</li>
<li>
<a href="../deploy/nginx_logrotate.html">Nginx日志按日期切割</a>
</li>
<li>
<a href="../deploy/samba_conf.html">Samba简单配置</a>
</li>
</ul>
</li>
<li>
<a href="#" class="aj-nav folder">CentOS</a>
<ul class="nav nav-list">
<li>
<a href="../centos/centos_install_mysql.html">安装Linux开发环境之一 —— MySQL</a>
</li>
<li>
<a href="../centos/centos_install_php.html">安装Linux开发环境之二 —— PHP</a>
</li>
<li>
<a href="../centos/centos_install_nginx.html">安装Linux开发环境之三 —— Nginx</a>
</li>
<li>
<a href="../centos/centos_install_redis.html">安装Linux开发环境之四 —— Redis</a>
</li>
<li>
<a href="../centos/centos_install_leveldb_beanstalkd.html">安装Linux开发环境之五 —— LevelDB、Beanstalkd</a>
</li>
<li>
<a href="../centos/centos_install_lamp.html">在CentOS上部署lamp环境</a>
</li>
</ul>
</li>
<li>
<a href="#" class="aj-nav folder">PHP</a>
<ul class="nav nav-list">
<li>
<a href="../php/zf2-multiple_dbs.html">Zend Framework 2 配置多个数据库</a>
</li>
<li>
<a href="../php/weight_rrd.html">PHP权重轮询</a>
</li>
<li>
<a href="../php/phpunit_boot.html">启动PHPUnit测试的简便方式</a>
</li>
</ul>
</li>
<li>
<a href="#" class="aj-nav folder">Python</a>
<ul class="nav nav-list">
<li>
<a href="../python/python_pop3.html">通过POP3协议读取指定邮件</a>
</li>
<li>
<a href="../python/python_pinyin.html">GB2312中文转拼音</a>
</li>
<li>
<a href="../python/python_md5.html">Python计算文件的MD5</a>
</li>
<li>
<a href="../python/python_mulpti_logging.html">Python多进程记录日志</a>
</li>
<li>
<a href="../python/python_paginate.html">一个Python分页</a>
</li>
<li>
<a href="../python/python_urlib.html">Python网址操作函数</a>
</li>
<li>
<a href="../python/python_pymssql_re2.html">安装Python支持SqlServer和re2</a>
</li>
<li>
<a href="../python/python_functions.html">收集用过的一些Python方法</a>
</li>
</ul>
</li>
<li class="open">
<a href="#" class="aj-nav folder">Tool</a>
<ul class="nav nav-list">
<li>
<a href="../tool/git_push.html">正确使用git避免提交冲突</a>
</li>
<li class="active">
<a href="../tool/haskell_mysql_dumper.html">MySQL导出CSV文件（Haskell实现）</a>
</li>
</ul>
</li>
<li>
<a href="#" class="aj-nav folder">Help</a>
<ul class="nav nav-list">
<li>
<a href="../help/github-flavored-markdown.html">Markdown 语法</a>
</li>
</ul>
</li>    </ul>
    <div class="well well-sidebar">
        <div><a href="#" id="toggleCodeBlockBtn" onclick="toggleCodeBlocks();">外置代码框</a></div>
            </div>
    <div class="well well-sidebar">
        <!-- Links -->
        <div><a href="https://coding.net/u/azhai/p/docx/git" target="_blank">Coding仓库</a></div><div><a href="http://git.oschina.net/azhai/docx" target="_blank">OSChina仓库</a></div><div><a href="http://todaymade.com" target="_blank">Todaymade出品Daux.io</a></div><div><a href="http://blog.emx2.co.uk" target="_blank">Xin Meng翻译文档</a></div>    </div>
</div>        </div>

        <div class="right-column content-area col-sm-9">
            <div class="content-page">
                <article>
                    <div class="page-header sub-header clearfix">
                        <h1>MySQL导出CSV文件（Haskell实现）
</h1>
                        <span style="float: left; font-size: 10px; color: gray;">
                        标签：mysql, haskell, dump, csv                        </span>
                        <span style="float: right; font-size: 10px; color: gray;">
                        <!--a href="../author/ryan-liu"-->
                        Ryan Liu<!--/a--> 写于 2015年5月20日 星期三                        </span>
                    </div>

                    <h1>为什么要写这个工具</h1>
<p>2015年3月份写的一个Haskell的程序，实现和mysql命令select into outfile差不多的功能。mysql的命令只能把文件导出到本机，另一个工具mydumper也能实现差不多的功能。</p>
<p>因为我需要简单地远程使用，又要比Navicat等界面工具使用更灵活。效率比mysql命令差一些，毕竟mysql的命令是C语言实现的，比Navicat好在可以自定义读取的字段和范围限制。</p>
<p>最后吐槽一下Haskell，这个文件编译后居然达到18M多。跟py2exe打包的Python程序一样大了，那个程序用到了PySide，打包了Python、Qt、libsvn的运行库。</p>
<h1>代码 hsdump.hs</h1>
<pre><code class="language-haskell">{-# LANGUAGE OverloadedStrings #-}
-- cabal update &amp;&amp; cabal install cabal-install
-- cabal install cassava &amp;&amp; cabal install yaml-config &amp;&amp; cabal install hdbc-mysql &amp;&amp; cabal install missingH
-- ghc -threaded -O2 -optc-O3 -funfolding-use-threshold=16 -fforce-recomp --make hsdump.hs

module Main where
import Control.Monad
import Data.Char (ord)
import Data.Csv
import Data.Convertible
import Data.Maybe (fromJust)
import qualified Data.ByteString.Lazy as Bytes (appendFile)
import qualified Data.List.Utils as Utils (join)
import qualified Data.Yaml.Config as Yaml
import Database.HDBC
import Database.HDBC.MySQL
import System.Directory (createDirectoryIfMissing)
import System.Environment (getArgs)

data Task =
    Task { sql :: String,
           params :: [SqlValue],
           outname :: String }

{- 拼接SQL语句，创建任务 -}
createTask :: Yaml.Config -&gt; String -&gt; String -&gt; Task
createTask sqlconf start_day stop_day =
    Task { sql = "SELECT " ++ (Utils.join "," fields) ++ " FROM " ++ table
                ++ " WHERE " ++ condition ++ " ORDER BY " ++ order,
           params = params,
           outname = dayname ++ ".txt" }
    where
        (table:_) = Yaml.lookup "table" sqlconf :: [String]
        (index:_) = Yaml.lookup "index" sqlconf :: [String]
        (order:_) = Yaml.lookup "order" sqlconf :: [String]
        fields = Yaml.lookupDefault "fields" ["*"] sqlconf :: [String]
        dayname = case start_day of
            "" -&gt; "20000000"
            otherwise -&gt; filter (/='-') start_day   -- 去掉日期中间的横杠
        condition = case (start_day, stop_day) of
            ("", _) -&gt; index ++ "&lt;? OR " ++ index ++ " IS NULL"
            (_, "") -&gt; index ++ "&gt;=?"
            otherwise -&gt; index ++ "&gt;=? AND " ++ index ++ "&lt;?"
        params = map toSql $ filter (/="") [start_day, stop_day]

{- 连接MySQL数据库 -}
connectDB :: Yaml.Config -&gt; IO Connection
connectDB dbconf =
    do
        conn &lt;- connectMySQL defaultMySQLConnectInfo {
            mysqlHost       = host,
            mysqlPort       = port,
            mysqlUser       = user,
            mysqlPassword   = password,
            mysqlDatabase   = database,
            mysqlUnixSocket = socket
        }
        runRaw conn "SET NAMES 'utf8'"              -- 设置字符集
        return conn
    where
        host = Yaml.lookupDefault "host" "localhost" dbconf :: String
        port = Yaml.lookupDefault "port" 3306 dbconf :: Int
        user = Yaml.lookupDefault "user" "root" dbconf :: String
        password = Yaml.lookupDefault "password" "" dbconf :: String
        database = Yaml.lookupDefault "database" "test" dbconf :: String
        socket = Yaml.lookupDefault "socket" "/var/lib/mysql.sock" dbconf :: String

{- 连接MS SQL SERVER数据库 -}
{-
import Database.HDBC.ODBC
connectDB :: Yaml.Config -&gt; IO Connection
connectDB dbconf =
    do
        connectODBC conn_string
    where
        dsn = Yaml.lookupDefault "dsn" "" dbconf :: String
        host = Yaml.lookupDefault "host" "localhost" dbconf :: String
        port = Yaml.lookupDefault "port" 1433 dbconf :: Int
        user = Yaml.lookupDefault "user" "root" dbconf :: String
        password = Yaml.lookupDefault "password" "" dbconf :: String
        database = Yaml.lookupDefault "database" "test" dbconf :: String
        servername = case dsn of
            "" -&gt; "Server=" ++ host ++ ";Port=" ++ (show port)
            otherwise -&gt; "DSN=" ++ dsn
        conn_string = "Driver=FreeTDS;TDS_Version=8.0;" ++ servername ++ ";UID=" ++ user 
            ++ ";PWD=" ++ password ++ ";Database=" ++ database ++ ";Options=262144"
-}

{- 将转义字符再转义，即将\n变成\\n -}
escape :: String -&gt; String
escape [] = []
escape (x:xs)
    | x `elem` ['\\', '\b', '\t', '\n', '\r'] = '\\' : x : escape xs
    | otherwise = x : escape xs

{- 将字段值转为字符串，其中NULL转为\N并转义 -}
fromMysql :: SqlValue -&gt; String
fromMysql SqlNull = "\\N"
fromMysql val = fromJust $ fromSql val :: String

{- 将字段值转为字符串，同时将原本为字符串类型的值中的转义字符再转义 -}
escapeFromMysql :: SqlValue -&gt; String
escapeFromMysql val@(SqlString _) = escape $ fromMysql val
escapeFromMysql val@(SqlByteString _) = escape $ fromMysql val
escapeFromMysql val@(SqlWord32 _) = escape $ fromMysql val
escapeFromMysql val@(SqlWord64 _) = escape $ fromMysql val
escapeFromMysql val = fromMysql val

dumpRecord :: [SqlValue] -&gt; [String]
dumpRecord row =
    map escapeFromMysql row

{- 输出结果到Tab分隔的CSV文件 -}
outputRecords :: String -&gt; Connection -&gt; Task -&gt; IO ()
outputRecords outpath conn task =
    do
        stmt &lt;- prepare conn (sql task)
        _ &lt;- execute stmt (params task)
        rows &lt;- fetchAllRows stmt
        Bytes.appendFile outfile $ encodeWith encOpts $ map dumpRecord rows
    where
        encOpts = defaultEncodeOptions {
            encDelimiter = fromIntegral (ord '\t'),
            encQuoting = QuoteNone
        }
        outfile = outpath ++ (outname task)

main :: IO ()
main = do
    args &lt;- getArgs                                 -- 读命令行参数，1个参数：yaml文件名
    conf &lt;- Yaml.load (head args)                   -- 加载yaml中的配置
    dbconf &lt;- Yaml.subconfig "db" conf
    sqlconf &lt;- Yaml.subconfig "sql" conf
    outconf &lt;- Yaml.subconfig "out" conf
    let path = Yaml.lookupDefault "path" "./data" outconf :: String
        pre = Yaml.lookupDefault "pre" "records-" outconf :: String
        outpath = path ++ "/" ++ pre
        (days:_) = Yaml.lookup "days" conf :: [[String]]
        tasks = zipWith (createTask sqlconf) days (tail days)   -- 以相邻两个日期作为最后两个参数
    createDirectoryIfMissing True path                          -- 如果目录不存在，就创建
    conn &lt;- connectDB dbconf
    mapM_ (outputRecords outpath conn) tasks    -- 调用查询输出结果命令
    disconnect conn</code></pre>
<h1>配置 task.yml</h1>
<pre><code class="language-ini">db:
    host:       localhost
    port:       3306
    user:       dba
    password:   password
    database:   test
    socket:     /var/lib/mysql/mysql.sock

sql:
    table:      users
    index:      created_at
    order:      id
    fields:     
        - id
        - username
        - password
        - created_at
        - modified_at
        - is_active

days:
    - ""
    - "2015-01-01"
    - "2015-02-01"
    - "2015-03-01"
    - "2015-04-01"
    - "2015-05-01"

out:
    path:   ./data
    pre:    users-</code></pre>                </article>
            </div>
        </div>

    </div>
</div>

<script src="../assets/js/jquery.min.js"></script> 
<script src="../assets/js/custom.js"></script> 
<!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<!-- hightlight.js -->
<script src="../assets/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>