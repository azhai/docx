<?php
class DOCX_App{const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';const URLEXT='{DOCX_URL_EXT}';const HTML_HIDE='{DOCX_HTML_HIDDEN}';protected$parsers=array();protected$templater=null;protected$documents=null;protected$document_dir='';protected$protected_dir='';protected$cache_dir='';protected$curr_metas=array();protected$curr_url='';protected$toppest_url='';protected$edit_mode=false;protected$options=array('title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','url_prefix'=>'','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','file_sort_latest'=>array(),'date_format'=>'Y年n月j日 星期w','repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($eB=false){if(is_array($eB)){$this->options=array_merge($this->options,$eB);}$this->document_dir=APP_ROOT.'/'.trim($this->options['document_dir'],' /');$this->public_dir=APP_ROOT.'/'.trim($this->options['public_dir'],' /');$this->cache_dir=APP_ROOT.'/'.trim($this->options['cache_dir'],' /');}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}static function isHome($lB){return$lB==='home';}protected static function getRawCurrURL(){$TB=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($TB)?'':$TB;}static function getURLPre($Q,$M='post.php'){$b=($M==='edit.php')?1:0;$RB=substr_count(trim($Q,'/'),'/')+intval($b);return($RB>0)?rtrim(str_repeat('../',$RB),'/'):'.';}protected function getCurrURL(){if(empty($this->curr_url)){$R=substr(self::getRawCurrURL(),strlen($this->options['url_prefix']));$R=rtrim(str_replace('/index.php','',$R),' /');if($R===self::ADMIN_URLPRE){$this->edit_mode=true;}else if(starts_with($R,self::ADMIN_URLPRE.'/')){$this->edit_mode=true;$R=substr($R,strlen(self::ADMIN_URLPRE));}if(empty($R)||$R==='/'){$this->curr_url=self::HOME_PAGE_URL;}else{$this->curr_url=urldecode(rtrim($R,'/'));}}return$this->curr_url;}function isEditMode(){return$this->edit_mode;}function getDocuments(){if(is_null($this->documents)){$w=$this->cache_dir.'/docs'.$this->options['cache_ext'];$this->documents=new DOCX_Directory($this->document_dir,'.md');$this->documents->addCache($w)->getFiles();}return$this->documents;}function ensureAssets(){$d=$this->public_dir.'/'.$this->options['assets_dir'];if(!file_exists($d)){$rB=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';$Z=APP_ROOT.'/'.$this->options['assets_dir'];@shell_exec($rB.' '.$Z.' '.$this->public_dir.'/');}}function getTemplater(){if(is_null($this->templater)){$this->ensureAssets();$hB=APP_ROOT.'/'.trim($this->options['theme_dir'],' /');$this->templater=new DOCX_Templater($hB,$this->cache_dir);$this->templater->globals=array('urlext'=>self::URLEXT,'html_hide'=>self::HTML_HIDE,'home_url'=>self::HOME_PAGE_URL,'admin_urlpre'=>self::ADMIN_URLPRE,'options'=>&$this->options,);}return$this->templater;}function getParser($Q){if(!isset($this->parsers[$Q])){$this->parsers[$Q]=new DOCX_Parser();}return$this->parsers[$Q];}function getMetadata($T,$Y=false){if($T===self::ADMIN_URLPRE){$T=self::HOME_PAGE_URL;}$F='.'.rtrim(dirname($T),'/');$H=basename($T);$L=$this->getDocuments();if(isset($L->files[$F])&&isset($L->files[$F][$H])){$E=$L->files[$F][$H];if($Y===false){return$E;}else if(isset($E[$Y])){return$E[$Y];}}}function genMetas($T=false){if($T===false||$T===self::ADMIN_URLPRE){$T=self::HOME_PAGE_URL;}$J=array();$L=$this->getDocuments();foreach($L->files as$F=>&$K){foreach($K as$H=>&$D){$Q=ltrim($F,'.').'/'.$H;$h=$this->getParser($Q);$E=$h->parseMetaData($D['fname']);$D['url']=$Q;$D['html']=$this->public_dir.$Q.'.html';$D['slug']=$H;$D=array_merge($D,$E);if($T===$Q){$J=$D;}}}return$J;}function run(){$FB=isset($_GET['action'])?$_GET['action']:false;if($FB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($FB==='staticize'){$this->curr_metas=$this->genMetas($this->getCurrURL());$this->genPages();}else if($FB==='genpdf'){$s=$this->genPDF();$s->send('docx.pdf',true);}if(!$this->curr_metas){$this->curr_metas=$this->genMetas($this->getCurrURL());}$BB=$this->isEditMode();if(self::isHome($this->curr_metas['slug'])){$M=$BB?'admin.php':'index.php';$A=$this->showPage($M,!$BB);}else if(!$BB){$A=$this->showPage('post.php',true);}else{if(self::isPost()){$HC=$this->curr_metas['fname'];$LC=$_POST['metatext']."\n\n".trim($_POST['markdown']);file_put_contents($HC,$LC,LOCK_EX);$A=$this->renderPage($this->curr_metas,'post.php');$this->staticize($this->curr_metas['html'],$A);}else{$A=$this->renderPage($this->curr_metas,'edit.php');}$A=$this->replaceURL($A);}@header('Content-Type: text/html; charset=utf8');return die($A);}function replaceURL($A){return str_replace(self::URLEXT,$this->options['urlext_php'],$A);}function staticize($t,$A){if(!$A){return;}@mkdir(dirname($t),0755,true);$KC=$this->options['urlext_html'];$wB='{display: none}';$A=str_replace(array(self::URLEXT,self::HTML_HIDE),array($KC,$wB),$A);return file_put_contents($t,$A,LOCK_EX);}function showPage($M='post.php',$MB=false){if(!$this->curr_metas){$this->curr_metas=$this->getMetadata($this->getCurrURL(),false);}$A=$this->renderPage($this->curr_metas,$M);if($MB){$t=$this->public_dir.rtrim($this->getCurrURL(),'/').'.html';$this->staticize($t,$A);}return$this->replaceURL($A);}function renderPage(array&$D,$M='post.php'){$h=$this->getParser($D['url']);$xB=$h->parseAll($D['fname']);$ZB='';if($M==='index.php'||$M==='admin.php'){$ZB=$this->getToppestPage();}$L=$this->getDocuments();$aB=$this->getTemplater();$aB->globals['docs']=&$L->files;$cB=self::getURLPre($D['url'],$M);$A=$aB->render($M,array('page'=>$xB,'curr_url'=>$D['url'],'urlpre'=>$cB,'first_page_url'=>$ZB,'assets_url'=>$cB.'/'.$this->options['assets_dir'],),true);return$A;}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$L=$this->getDocuments();foreach($L->files as$F=>&$K){foreach($K as$H=>&$D){if(!self::isHome($D['slug'])){return$D['url'];}}}}function genPages(){DOCX_Directory::removeAll($this->public_dir,array('.','index.php'));$L=$this->getDocuments();foreach($L->files as$F=>&$K){foreach($K as$H=>&$D){$M=self::isHome($D['slug'])?'index.php':'post.php';if($A=$this->renderPage($D,$M)){$this->staticize($D['html'],$A);}}}}function genPDF($MB=false){require_once APP_ROOT.'/library/WkHtmlToPdf.php';$d=$this->public_dir.'/'.$this->options['assets_dir'];$s=new WkHtmlToPdf(array('binPath'=>$this->options['wkhtmltopdf'],'encoding'=>'UTF-8','user-style-sheet'=>$d.'/css/style.min.css','run-script'=>array($d.'/js/jquery.min.js',$d.'/js/highlight.min.js',$d.'/js/pdfscript.js',),));$L=$this->getDocuments();foreach($L->files as$F=>&$K){foreach($K as$H=>&$D){if(self::isHome($D['slug'])){}else{$A=$this->renderPage($D,'pdf.php',true);if($A=$this->replaceURL($A)){$s->addPage($A);}}}}return$s;}}class DOCX_Cache{protected$data=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($P,&$j=null,&$HB=null){$this->setPath($P);$this->reader=$j;$this->writer=$HB;register_shutdown_function(function($AC){$AC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if(empty($this->signature)||$this->signature!==$this->sign()){$this->save();}unset($this->data);}function offsetGet($b){if(isset($this->data[$b])){return$this->data[$b];}}function offsetSet($b,&$zB){$this->data[$b]=$zB;return$this;}function setPath($P){$this->path=$P;return$this;}function connect(&$PB,$NB=null){if(empty($NB)){$this->data=&$PB;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$NB]=&$PB;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$j=$this->getReader();$this->writer=&$j;}return$this->writer;}function sign(){return serialize($this->data);}function load(){if($j=$this->getReader()){$B=$j->read($this->path);if(!is_null($B)){$this->data=$B;$this->signature=$this->sign();}}return$this->data;}function save(){if($HB=$this->getWriter()){$HB->write($this->path,$this->data);}return$this->data;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{var$dir='';var$extname=false;var$files=array();function __construct($P='.',$l=false){$P=realpath($P);if(is_dir($P)){$this->dir=$P;$this->extname=$l;}}static function removeEmpty($F,$UB=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($F)){return 0;}$f=0;if($UB>=1||$UB>=mt_rand(1,10000)/10000){$K=scandir($F);if(is_array($K)&&count($K)===2){if($K[0]==='.'&&$K[1]==='..'){@rmdir($F);$f++;}}}return$f;}static function removeAll($F,array$EB=array()){if(!file_exists($F)){return 0;}$f=0;$_B=scandir($F);foreach($_B as$S){if($EB&&in_array($S,$EB)){continue;}$GB=rtrim($F,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$S;if(is_dir($GB)){if($S==='.'||$S==='..'){continue;}self::removeAll($GB);}else{unlink($GB);$f++;}}if(!in_array('.',$EB)){rmdir($F);}return$f;}static function eraseOrd($N,$JB='_',$q=false){$N=$q?basename($N,$q):basename($N);$I=explode($JB,$N,2);if(count($I)===2&&is_numeric($I[0])){return$I[1];}return$N;}function addCache($w){$a=new DOCX_Cache($w);$a->connect($this->files)->load();return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->dir);}return$this->files;}function scan($P,$WB='.'){if($XB=opendir($P)){while(($r=readdir($XB))!==false){if(substr($r,0,1)==='.'){continue;}$S=$P.DIRECTORY_SEPARATOR.$r;$l='.'.pathinfo($r,PATHINFO_EXTENSION);$dB=self::eraseOrd($r,'_',$this->extname?$this->extname:$l);if(is_dir($S)){$gB=$WB.'/'.$dB;$this->files[$gB]=array();$this->scan($S,$gB);}else if($this->extname===false||$this->extname===$l){$this->files[$WB][$dB]=array('mtime'=>filemtime($S),'fname'=>$S,);}}closedir($XB);ksort($this->files);}return$this;}function diff(){$x=$this->getFiles();$this->files=array();$this->scan($this->dir);$J=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$J['deldirs']=array_diff_key($x,$this->files);foreach($this->files as$F=>$K){$y=isset($x[$F])?$x[$F]:array();if($yB=array_diff_key($y,$K)){$J['delfiles'][$F]=$yB;}$_=array();$z=array();foreach($K as$H=>$D){if(!isset($y[$H])){$_[$H]=$D;}else if($D['mtime']>$y[$H]['mtime']){$z[$H]=$D;}}if(!empty($_)){$J['addfiles'][$F]=&$_;}if(!empty($z)){$J['modfiles'][$F]=&$z;}}return$J;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($C,$tB=false){assert(is_string($C));if($tB&&!is_file($C)){try{@mkdir(dirname($C),CACHE_DIR_MODE,true);@touch($C);@chmod($C,CACHE_FILE_MODE);}catch(\Exception$MC){return false;}}if($this->extname===false){$this->extname=pathinfo($C,PATHINFO_EXTENSION);}return$C;}function read($C,$uB=null){$B=null;if($C=$this->prepare($C,true)){$VB='_read'.$this->extname;if(method_exists($this,$VB)){$B=$this->$VB($C);}else{$B=$this->_read($C);}}return(is_null($B)||$B===false)?$uB:$B;}function write($C,&$B,$vB=0){if($C=$this->prepare($C,true)){$YB='_write'.$this->extname;if(method_exists($this,$YB)){return$this->$YB($C,$B);}else{return$this->_write($C,$B);}}}function delete($C){if($C=$this->prepare($C,false)){unlink($C);DOCX_Directory::unlinkEmpty(dirname($C));}}protected function _read($C){if($B=file_get_contents($C)){$SB='_unformat'.$this->extname;if(method_exists($this,$SB)){return$this->$SB($B);}else{return$B;}}}protected function _write($C,&$B,$vB=0){$k='_format'.$this->extname;if(method_exists($this,$k)){$A=$this->$k($B);}else{$A=$B;}return file_put_contents($C,$A,LOCK_EX);}protected function _readPHP($C){if(filesize($C)>0){return(include$C);}}protected function _formatPHP(&$B){return"<?php \nreturn ".var_export($B,true).";\n";}protected function _readCSV($C){$B=array();if(($O=fopen($C,'rb'))!==false){while(($v=fgetcsv($O,0,$this->csv_delimiter))!==false){$B[]=$v;}fclose($O);}return$B;}protected function _writeCSV($C,&$B){$KB=0;if(($O=fopen($C,'wb'))!==false){foreach($B as$v){$KB+=fputcsv($O,$v,$this->csv_delimiter);}fclose($O);}return$KB;}protected function _formatJSON(&$B){return json_encode($B);}protected function _unformatJSON(&$B){return json_decode($B,true);}protected function _formatYAML(&$B){if(extension_loaded('yaml')){return yaml_emit($B,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$CC=new Yaml\Dumper();return$CC->dump($B);}}protected function _unformatYAML(&$B){if(extension_loaded('yaml')){return yaml_parse($B);}else if(class_exists('Yaml\\Parser',true)){$h=new Yaml\Parser();return$h->parse($B);}}}class DOCX_Parser{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');var$metadata=array();protected$filename='';protected$dochtml='';protected$markdown='';protected$metatext='';protected$headsize=0;static function parseMetaLine($G){$I=explode(':',$G);if(count($I)===2){$I[0]=strtolower(trim($I[0]));if(in_array($I[0],self::$meta_keys,true)){$I[1]=trim($I[1]);return$I;}}}function normalizeMetaData(array&$E){if(!isset($E['title'])){$E['title']=clean_ord($this->filename);}if(!isset($E['author'])){$E['author']='';}if(isset($E['tags'])&&is_string($E['tags'])){$E['tags']=array_map('trim',explode(',',$E['tags']));}if(!isset($E['date'])){$E['date']=filemtime($this->filename);}else if(!is_numeric($E['date'])){$E['date']=strtotime($E['date']);}return$this->metadata=&$E;}function parseMetaData($c,$Y=false,$sB=false){if($this->filename!==$c){$this->filename=$c;$this->metatext='';$E=array();$O=fopen($this->filename,'rb');if($O===false){return false;}$G=fgets($O);$G=$G?trim($G):'';$G=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$G);while(!$G||!trim($G));$u=0;while($p=strlen($G)){$this->metatext.=$G."\n";if($p>=3&&$G===str_repeat('-',$p)){if($u<=0){$u=$p;}else if($u===$p){$G='';break;}}else if($OB=self::parseMetaLine($G)){$E[$OB[0]]=$OB[1];}else{break;}$G=fgets($O);$G=$G?trim($G):'';}if($sB){$this->markdown=$G.fread($O,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$G;$this->headsize=ftell($O);}fclose($O);$this->metatext=trim($this->metatext);$this->normalizeMetaData($E);}if($Y===false){return$this->metadata;}else if(isset($this->metadata[$Y])){return$this->metadata[$Y];}}function parseAll($c){if($this->filename!==$c){if(!is_readable($c)){$this->metadata=array('title'=>'Oh No');$this->dochtml='<h3>抱歉，找不到页面~!</h3>';}else{$this->parseMetaData($c,false,true);}}else if($this->headsize>0||!$this->markdown){$A=file_get_contents($this->filename);$this->markdown=substr($A,$this->headsize);}if(!$this->dochtml&&$this->markdown){$this->dochtml=Parsedown::instance()->text($this->markdown);}$JC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'dochtml'=>$this->dochtml,);return array_merge($this->metadata,$JC);}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($Z,$IC=''){if($Z){$this->setSourceDir($Z);}$this->cache_dir=rtrim($IC,' /\\');}static function replaceWith($A,array$V=array()){if(!empty($V)){$DC=array_map(create_function('$x','return "\${$x}";'),array_keys($V));$EC=array_map(create_function('$x','return "%$x\$s";'),range(1,count($V)));$A=vsprintf(str_replace($DC,$EC,$A),$V);}return$A;}function setSourceDir($Z){$this->source_dir=rtrim($Z,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($o,&$A){if(!isset($this->caches[$o])){$a=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$o);$this->caches[$o]=&$a;}else{$a=&$this->caches[$o];}$a->connect($A)->load();return$a;}function updateGlobals(array$FC){$this->globals=array_merge($this->globals,$FC);}function prepareFile($X){return$this->source_dir.'/'.$X;}function render($X,array$V=array(),$QB=false){$this->current_file=$X;if($QB){ob_start();}extract($this->globals);extract($V);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$GC=array_pop($this->extend_files);foreach($this->extend_files as$H){include$this->prepareFile($H);}extract($this->template_blocks);include$this->prepareFile($GC);}if($QB){$J=ob_get_clean();return$J?trim($J):'';}}function extendTpl($X){array_push($this->extend_files,$X);}function includeTpl($X,array$V=array(),$BC=false){extract($this->globals);extract($V);include$this->prepareFile($X);}function blockStart($kB='content',$BC=false){$this->current_block=$kB;ob_start();}function blockEnd(){$jB=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$jB;}}function starts_with($m,$g){return strncmp($m,$g,strlen($g))===0;}function ends_with($m,$g){$CB=strlen($g);return$CB===0||(strlen($m)>=$CB&&substr_compare($m,$g,-$CB)===0);}function convert($n,$e='UTF-8'){$e=strtoupper($e);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($n,$e,true)?$n:mb_convert_encoding($n,$e,'UTF-8, GBK');}else if(function_exists('iconv')){$pB=$e==='UTF-8'?'GBK':'UTF-8';return iconv($pB,$e.'//IGNORE',$n);}}function compare_pathes($U,$W){if($U===$W){return array($U,0,0);}else if(starts_with($U,$W)){$qB=substr_count(substr($U,strlen($W)),'/');return array($W,0,$qB);}else if(starts_with($W,$U)){$mB=substr_count(substr($W,strlen($U)),'/');return array($U,$mB,0);}$LB=explode('/',$W);$IB=explode('/',$U);$fB=count($LB);foreach($IB as$i=>$oB){if($i>=$fB||$oB!==$LB[$i]){$nB=implode('/',array_slice($IB,0,$i));return array($nB,$fB-$i,count($IB)-$i);}}return array('',-1,-1);}function clean_ord($N,$q='.md',$JB='_'){$N=basename($N,$q);$I=explode($JB,$N,2);if(count($I)===2&&is_numeric($I[0])){return$I[1];}return$N;}function slugify($N){return strtolower(str_replace(' ','-',$N));}function rand_greeting($AB){static$DB=0;if($DB===0){shuffle($AB);$DB=count($AB);}return$AB[--$DB];}function zh_date($k,$iB=false){$J=date($k,$iB);if(strpos($k,'星期w')!==false){$bB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$J=str_replace(array_keys($bB),array_values($bB),$J);}return$J;}