<?php
class DOCX_App{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$document_dir='';var$public_dir='';var$cache_dir='';protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$offset=0;protected$route='r';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>self::URL_TYPE_AUTO,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($qB=false){if(is_array($qB)){$this->options=array_merge($this->options,$qB);}$this->document_dir=APP_ROOT.'/'.trim($this->getOption('document_dir'),' /');$this->public_dir=APP_ROOT.'/'.trim($this->getOption('public_dir'),' /');$this->cache_dir=APP_ROOT.'/'.trim($this->getOption('cache_dir'),' /');$this->abs_prefix=$this->getAbsPrefix();}static function isHome($PC){return$PC==='home';}static function getRawURL(){$a=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($a)?'/':urldecode($a);}function getConstant($K){return constant(__CLASS__.'::'.$K);}function getOption($P=false){if($P===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$P])){return$_ENV[$P];}else if(isset($this->options[$P])){return$this->options[$P];}}function getAbsPrefix(){if($this->abs_prefix!==false){return$this->abs_prefix;}$this->url_type=intval($this->getOption('url_type'));$this->abs_prefix=rtrim($this->getOption('url_prefix'),'/');$OC=array(self::URL_TYPE_QUERY,self::URL_TYPE_TAIL,self::URL_TYPE_REWRITE);if(!in_array($this->url_type,$OC)){$this->url_type=$this->fixURLType();}return$this->abs_prefix;}function fixURLType(){$hB=strpos($this->abs_prefix,'index.php');if($hB===false){$this->url_type=self::URL_TYPE_REWRITE;$this->abs_prefix=rtrim($this->abs_prefix,'/');}else{$IC='/^\?([^=?&]+)=/';$ZB=substr($this->abs_prefix,$hB+strlen('index.php'));if(preg_match($IC,$ZB,$HC)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$HC[0];}else{$this->url_type=self::URL_TYPE_TAIL;}$this->abs_prefix=rtrim($this->abs_prefix,'?&');}return$this->url_type;}function getCurrURL($CC=false){$a=self::getRawURL();if($this->url_type===self::URL_TYPE_QUERY){$E='';if(isset($_GET[$this->route])){$E='/'.trim($_GET[$this->route],'/').'/';}$this->offset=-99;}else{if($this->url_type===self::URL_TYPE_REWRITE){$a=str_replace('/index.php','/',$a);$this->offset=-1;}$kB=strlen($this->getAbsPrefix());$E=(strlen($a)>$kB)?substr($a,$kB):'';}return$CC?rtrim($E,'/'):$E;}function getURLJoin(){if($this->url_type===self::URL_TYPE_QUERY&&!empty($_GET)){$ZB=urldecode(http_build_query($_GET));return"?$ZB&";}else{return'?';}}function getRelPrefix($E=false){if($E===false){if($this->url_type===self::URL_TYPE_QUERY){return'.';}$E=$this->getCurrURL(false);$XB=substr_count($E,'/')+$this->offset;}else{$XB=substr_count($E,'/');}return($XB>0)?rtrim(str_repeat('../',$XB),'/'):'.';}function getDocsDir(){if(is_null($this->docs_dir)){$WB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($LC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($LC,DOCX_Directory::ATTR_FILE_MTIME,true);}$_=$this->docs_dir->addCache($WB)->getDiffs();$this->updateMetas($_['addfiles']);$this->updateMetas($_['modfiles']);}return$this->docs_dir;}function updateMetas($_){foreach($_ as$D=>$F){foreach($F as$G){$A=&$this->docs_dir->files[$D][$G];$A['slug']=$G;$A['url']=ltrim($D,'.').'/'.$G;$z=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$z->getMetaData());}}}function getMetadata($y){if($y===self::ADMIN_URLPRE){$y=self::HOME_PAGE_URL;}$D='.'.rtrim(dirname($y),'/');$G=basename($y);$Z=$this->getDocsDir();if(isset($Z->files[$D])&&isset($Z->files[$D][$G])){return$Z->files[$D][$G];}}function dispatch(){$E=$this->getCurrURL(true);$Y=false;if(empty($E)||in_array($E,array('/',self::HOME_PAGE_URL))){$E=self::HOME_PAGE_URL;}else if($E===self::ADMIN_URLPRE){$E=self::HOME_PAGE_URL;$Y=true;}else if(starts_with($E,self::ADMIN_URLPRE.'/')){$E=substr($E,strlen(self::ADMIN_URLPRE));$Y=true;}$A=$this->getMetadata($E);if(is_null($A)){die($E);}$l=new DOCX_View($this,$A,'',$Y);return$l;}function run(){$RB=isset($_GET['action'])?$_GET['action']:false;if($RB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($RB==='staticize'){$this->genPages();return http_redirect($this->getStaticIndex());}else if($RB==='genpdf'){$s=$this->genPDF();return$s->send($this->getOption('title').'.pdf',true);}$this->dispatch()->output();}function getStaticIndex(){$h=$this->getRelPrefix();$dC=trim($this->getOption('public_dir'),' /');$T=$this->getOption('urlext_html');return$h.'/'.$dC.'/index'.$T;}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$Z=$this->getDocsDir();foreach($Z->files as$D=>&$F){foreach($F as$G=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($N=false){if($N===false){$N=$this->public_dir;}$T=$this->getOption('urlext_html');DOCX_Directory::removeAll($this->public_dir,array('.','index.php'));$Z=$this->getDocsDir();foreach($Z->files as$D=>&$F){foreach($F as$G=>&$A){$e=$N.$A['url'].$T;$l=new DOCX_View($this,$A,'',false);$l->staticize($e);}}}function genPDF(){require_once APP_ROOT.'/library/WkHtmlToPdf.php';$U=APP_ROOT.'/'.trim($this->getOption('assets_dir'),'/');$s=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$U.'/css/style.min.css','run-script'=>array($U.'/js/jquery.min.js',$U.'/js/highlight.min.js',$U.'/js/pdfscript.js',),));$TB=$this->getDocsDir();foreach($TB->files as$D=>&$F){foreach($F as$G=>&$A){if(self::isHome($A['slug'])){}else{$l=new DOCX_View($this,$A,'pdf.php',false);if($I=$l->getStaticContent()){$s->addPage($I);}}}}return$s;}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($O,&$m=null,&$UB=null){$this->setPath($O);$this->reader=$m;$this->writer=$UB;register_shutdown_function(function($UC){$UC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($O){$this->path=$O;return$this;}function connect(&$eB,$P=null){if(empty($P)){$this->data=&$eB;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$P]=&$eB;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$m=$this->getReader();$this->writer=&$m;}return$this->writer;}function load(&$cB=null){if($m=$this->getReader()){$B=$m->read($this->path);if(!is_null($B)){$this->data=$B;}if(!is_null($cB)){$this->changed=&$cB;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($UB=$this->getWriter()){$UB->write($this->path,$this->data);}return$this->data;}function offsetGet($t){if(isset($this->data[$t])){return$this->data[$t];}}function offsetSet($t,&$aB){$this->data[$t]=$aB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($O='.',$BB=false,$R=self::ATTR_FILE_MTIME){$O=realpath($O);if(is_dir($O)){$this->dir=$O;$this->extname=$BB;}$this->attr_cmp=$R;}static function removeEmpty($D,$bB=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($D)){return 0;}$j=0;if($bB>=1||$bB>=mt_rand(1,10000)/10000){$F=scandir($D);if(is_array($F)&&count($F)===2){if($F[0]==='.'&&$F[1]==='..'){@rmdir($D);$j++;}}}return$j;}static function removeAll($D,array$SB=array()){if(!file_exists($D)){return 0;}$j=0;$XC=scandir($D);foreach($XC as$S){if($SB&&in_array($S,$SB)){continue;}$YB=rtrim($D,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$S;if(is_dir($YB)){if($S==='.'||$S==='..'){continue;}self::removeAll($YB);}else{unlink($YB);$j++;}}if(!in_array('.',$SB)){rmdir($D);}return$j;}static function eraseOrd($K,$QB='_',$q=false){$K=$q?basename($K,$q):basename($K);$J=explode($QB,$K,2);if(count($J)===2&&is_numeric($J[0])){return$J[1];}return$K;}static function getAttrFunc($R){switch($R){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$F,$R,$VB=false){if(in_array($R,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$rB='return $a["'.$R.'"] - $b["'.$R.'"];';}else{$rB='return strcasecmp($a["'.$R.'"], $b["'.$R.'"]);';}$DC=$VB?'$b, $a':'$a, $b';uasort($F,create_function($DC,$rB));}function sortSubDir($w){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$EC=ltrim($w,'.');foreach($this->order_prefixes as$d){if(starts_with($EC,$d)){self::sortFiles($this->files[$w],$this->order_attr,$this->order_desc);}}}function setSorting(array$uB,$tB,$VB=false){if($uB&&$tB===$this->attr_cmp){$this->order_prefixes=$uB;$this->order_attr=$tB;$this->order_desc=$VB;}return$this;}function addCache($WB){$f=new DOCX_Cache($WB);$f->connect($this->files)->load($this->changed);return$this;}function scan(array&$F,$O,$d='.'){$xB=scandir($O);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($xB);}foreach($xB as$r){if(substr($r,0,1)==='.'){continue;}$S=$O.DIRECTORY_SEPARATOR.$r;$BB='.'.pathinfo($r,PATHINFO_EXTENSION);$wB=self::eraseOrd($r,'_',$this->extname?$this->extname:$BB);if(is_dir($S)){$yB=$d.'/'.$wB;$F[$yB]=array();$this->scan($F,$S,$yB);}else if($this->extname===false||$this->extname===$BB){$TC=self::getAttrFunc($this->attr_cmp);$F[$d][$wB]=array('fname'=>$S,$this->attr_cmp=>$TC($S),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$w){$this->sortSubDir($w);}}}return$this->files;}function getDiffs(){$IB=array();$this->scan($IB,$this->dir);$L=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$L['deldirs']=array_diff(array_keys($this->files),array_keys($IB));if(!empty($L['deldirs'])){foreach($L['deldirs']as$D){unset($this->files[$D]);}$this->changed=true;}foreach($IB as$D=>&$F){$PB=isset($this->files[$D])?$this->files[$D]:array();if($DB=array_diff(array_keys($PB),array_keys($F))){$L['delfiles'][$D]=$DB;if(!empty($DB)){foreach($DB as$G){unset($this->files[$D][$G]);}$this->changed=true;}}$FB=array();$GB=array();foreach($F as$G=>&$EB){if(!isset($PB[$G])){$FB[]=$G;$this->files[$D][$G]=&$EB;}else if($EB[$this->attr_cmp]!==$PB[$G][$this->attr_cmp]){$GB[]=$G;$this->files[$D][$G]=&$EB;}}if(!empty($FB)){$L['addfiles'][$D]=$FB;$this->changed=true;}if(!empty($GB)){$L['modfiles'][$D]=$GB;$this->changed=true;}$this->sortSubDir($D);}return$L;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($C,$jC=false){assert(is_string($C));if($jC&&!is_file($C)){try{@mkdir(dirname($C),CACHE_DIR_MODE,true);@touch($C);@chmod($C,CACHE_FILE_MODE);}catch(\Exception$mC){return false;}}if($this->extname===false){$this->extname=pathinfo($C,PATHINFO_EXTENSION);}return$C;}function read($C,$QC=null){$B=null;if($C=$this->prepare($C,true)){$vB='_read'.$this->extname;if(method_exists($this,$vB)){$B=$this->$vB($C);}else{$B=$this->_read($C);}}return(is_null($B)||$B===false)?$QC:$B;}function write($C,&$B,$cC=0){if($C=$this->prepare($C,true)){$sB='_write'.$this->extname;if(method_exists($this,$sB)){return$this->$sB($C,$B);}else{return$this->_write($C,$B);}}}function delete($C){if($C=$this->prepare($C,false)){unlink($C);DOCX_Directory::unlinkEmpty(dirname($C));}}protected function _read($C){if($B=file_get_contents($C)){$pB='_unformat'.$this->extname;if(method_exists($this,$pB)){return$this->$pB($B);}else{return$B;}}}protected function _write($C,&$B,$cC=0){$i='_format'.$this->extname;if(method_exists($this,$i)){$I=$this->$i($B);}else{$I=$B;}return file_put_contents($C,$I,LOCK_EX);}protected function _readPHP($C){if(filesize($C)>0){return(include$C);}}protected function _formatPHP(&$B){return"<?php \nreturn ".var_export($B,true).";\n";}protected function _readCSV($C){$B=array();if(($M=fopen($C,'rb'))!==false){while(($MB=fgetcsv($M,0,$this->csv_delimiter))!==false){$B[]=$MB;}fclose($M);}return$B;}protected function _writeCSV($C,&$B){$zB=0;if(($M=fopen($C,'wb'))!==false){foreach($B as$MB){$zB+=fputcsv($M,$MB,$this->csv_delimiter);}fclose($M);}return$zB;}protected function _formatJSON(&$B){return json_encode($B);}protected function _unformatJSON(&$B){return json_decode($B,true);}protected function _formatYAML(&$B){if(extension_loaded('yaml')){return yaml_emit($B,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$ZC=new Yaml\Dumper();return$ZC->dump($B);}}protected function _unformatYAML(&$B){if(extension_loaded('yaml')){return yaml_parse($B);}else if(class_exists('Yaml\\Parser',true)){$YC=new Yaml\Parser();return$YC->parse($B);}}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$dochtml='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($c){$this->filename=$c;}static function getInstance($c){if(!isset(self::$instances[$c])){self::$instances[$c]=new self($c);}return self::$instances[$c];}static function parseMetaLine($H){$J=explode(':',$H);if(count($J)===2){$J[0]=strtolower(trim($J[0]));if(in_array($J[0],self::$meta_keys,true)){$J[1]=trim($J[1]);return$J;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($fC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->dochtml='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$M=fopen($this->filename,'rb');if($M===false){return false;}$H=fgets($M);$H=$H?trim($H):'';$H=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$H);while(!$H||!trim($H));$LB=0;while($o=strlen($H)){$this->metatext.=$H."\n";if($o>=3&&$H===str_repeat('-',$o)){if($LB<=0){$LB=$o;}else if($LB===$o){$H='';break;}}else if($dB=self::parseMetaLine($H)){$A[$dB[0]]=$dB[1];}else{break;}$H=fgets($M);$H=$H?trim($H):'';}if($fC){$this->markdown=$H.fread($M,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$H;$this->headsize=ftell($M);}fclose($M);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($HB=false){if($this->headsize<0){$this->parseMetaData(false);}if($HB===false){return$this->metadata;}else if(isset($this->metadata[$HB])){return$this->metadata[$HB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$I=file_get_contents($this->filename);$this->markdown=substr($I,$this->headsize);$this->headsize=0;}if(!$this->dochtml&&$this->markdown){$this->dochtml=Parsedown::instance()->text($this->markdown);}$aC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'dochtml'=>$this->dochtml,);return array_merge($this->metadata,$aC);}function update($WC,$VC){$I=$WC."\n\n".$VC;file_put_contents($this->filename,$I,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($AB,$RC=''){if($AB){$this->setSourceDir($AB);}$this->cache_dir=rtrim($RC,' /\\');}static function replaceWith($I,array$g=array(),$d='',$SC=''){if(!empty($g)){$nB=array();$oB=array();foreach($g as$P=>&$aB){$nB[]=$d.$P.$SC;$oB[]=$aB;}$I=str_replace($nB,$oB,$I);}return$I;}function setSourceDir($AB){$this->source_dir=rtrim($AB,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($x,&$I){if(!isset($this->caches[$x])){$f=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$x);$this->caches[$x]=&$f;}else{$f=&$this->caches[$x];}$f->connect($I)->load();return$f;}function updateGlobals(array$bC){$this->globals=array_merge($this->globals,$bC);}function prepareFile($W){return$this->source_dir.'/'.$W;}function render($W,array$g=array(),$lB=false){$this->current_file=$W;if($lB){ob_start();}extract($this->globals);extract($g);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$iC=array_pop($this->extend_files);foreach($this->extend_files as$G){include$this->prepareFile($G);}extract($this->template_blocks);include$this->prepareFile($iC);}if($lB){$L=ob_get_clean();return$L?trim($L):'';}}function extendTpl($W){array_push($this->extend_files,$W);}function includeTpl($W,array$g=array(),$kC=false){extract($this->globals);extract($g);include$this->prepareFile($W);}function blockStart($lC='content',$kC=false){$this->current_block=$lC;ob_start();}function blockEnd(){$hC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$hC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($gC,array&$A,$Q='',$Y=false){$this->app=$gC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($Q,$Y);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($Q,$Y=false){if(empty($Q)){if(isset($this->metadata['layout'])){$Q=$this->metadata['layout'];}if(empty($Q)){$Q=$this->app->getOption('layout');}$Q=($Y?'edit/':'').$Q.'.php';}$JB=APP_ROOT.'/'.trim($this->app->getOption('theme_dir'),' /');return is_readable($JB.'/'.$Q)?$Q:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($N=false){if($N===false){$N=$this->app->public_dir;}$U=$this->app->getOption('assets_dir');if(!file_exists($N.'/'.$U)){$eC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';$fB=APP_ROOT.'/'.$U;if(realpath($N.'/assets')!==$fB){@shell_exec($eC.' '.$fB.' '.$N.'/assets');}}}function getTemplater(){if(is_null($this->templater)){$TB=$this->app->getDocsDir();$JB=APP_ROOT.'/'.trim($this->app->getOption('theme_dir'),' /');$this->templater=new DOCX_Templater($JB,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'url_join'=>$this->app->getURLJoin(),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$TB->files,);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$z=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$z->update($_POST['metatext'],trim($_POST['markdown']));}$mB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$mB=$this->app->getToppestPage();}$p=$this->getTemplater();$p->globals['urlpre']=self::URL_PRE;$p->globals['urlext']=self::URL_EXT;$p->globals['assets_url']=self::URL_ASSETS;$this->content=$p->render($this->tpl_file,array('view'=>&$this,'page'=>$z->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$mB,),true);}function output(){$this->renderPage();$T=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$T;$this->replacers[self::HTML_HIDE]='{}';$h=$this->app->getRelPrefix();$U=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$h.'/'.$U;$I=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($I);}function getStaticContent(){$this->renderPage();$T=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$T;$this->replacers[self::HTML_HIDE]='{display: none}';$E=$this->metadata['url'].$T;$h=$this->app->getRelPrefix(ltrim($E,'/'));$this->replacers[self::URL_PRE]=$h;$this->replacers[self::URL_ASSETS]=$h.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($e=false){$N=$this->app->public_dir;$this->ensureAssets($N);if($e===false){$e=$N.$this->metadata['url'].$T;}@mkdir(dirname($e),0755,true);$I=$this->getStaticContent();return file_put_contents($e,$I,LOCK_EX);}}function starts_with($u,$n){return strncmp($u,$n,strlen($n))===0;}function ends_with($u,$n){$KB=strlen($n);return$KB===0||(strlen($u)>=$KB&&substr_compare($u,$n,-$KB)===0);}function convert($v,$b='UTF-8'){$b=strtoupper($b);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($v,$b,true)?$v:mb_convert_encoding($v,$b,'UTF-8, GBK');}else if(function_exists('iconv')){$GC=$b==='UTF-8'?'GBK':'UTF-8';return iconv($GC,$b.'//IGNORE',$v);}}function http_redirect($_B='',$AC=false){$FC=$AC?301:302;@header('Location: '.$_B,true,$FC);return die();}function compare_pathes($V,$X){if($V===$X){return array($V,0,0);}else if(starts_with($V,$X)){$NC=substr_count(substr($V,strlen($X)),'/');return array($X,0,$NC);}else if(starts_with($X,$V)){$MC=substr_count(substr($X,strlen($V)),'/');return array($V,$MC,0);}$jB=explode('/',$X);$NB=explode('/',$V);$gB=count($jB);foreach($NB as$k=>$KC){if($k>=$gB||$KC!==$jB[$k]){$JC=implode('/',array_slice($NB,0,$k));return array($JC,$gB-$k,count($NB)-$k);}}return array('',-1,-1);}function clean_ord($K,$q='.md',$QB='_'){$K=basename($K,$q);$J=explode($QB,$K,2);if(count($J)===2&&is_numeric($J[0])){return$J[1];}return$K;}function slugify($K){return strtolower(str_replace(' ','-',$K));}function rand_greeting($OB){static$CB=0;if($CB===0){shuffle($OB);$CB=count($OB);}return$OB[--$CB];}function zh_date($i,$BC=false){$L=date($i,$BC);if(strpos($i,'星期w')!==false){$iB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$L=str_replace(array_keys($iB),array_values($iB),$L);}return$L;}