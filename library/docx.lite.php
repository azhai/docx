<?php
class DOCX_App{const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$linkage=null;var$document_dir='';var$public_dir='';var$cache_dir='';var$theme_dir='';var$assets_dir='';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>9,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','publish_branch'=>false,'publish_repo'=>false,'github_repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($BC=false){if(is_array($BC)){$this->options=array_merge($this->options,$BC);}$this->document_dir=self::getRealPath($this->getOption('document_dir'));$this->public_dir=self::getRealPath($this->getOption('public_dir'));$this->cache_dir=self::getRealPath($this->getOption('cache_dir'));$this->theme_dir=self::getRealPath($this->getOption('theme_dir'));$this->assets_dir=self::getRealPath($this->getOption('assets_dir'));$this->linkage=new DOCX_Linkage($this->getOption('url_prefix'),$this->getOption('url_type'));}static function getConstant($K){return constant(__CLASS__.'::'.$K);}static function getRealPath($B){$H=starts_with($B,'/')?$B:$H=DOCX_ROOT.'/'.$B;if(($GC=realpath($H))===false){@mkdir($H,0755,true);$GC=realpath($H);}return$GC;}static function isHome($TC){return$TC==='home';}function getOption($P=false){if($P===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$P])){return$_ENV[$P];}else if(isset($this->options[$P])){return$this->options[$P];}}function getDocsDir(){if(is_null($this->docs_dir)){$WB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($SC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($SC,DOCX_Directory::ATTR_FILE_MTIME,true);}$HB=$this->docs_dir->addCache($WB)->getDiffs();$this->updateMetas($HB['addfiles']);$this->updateMetas($HB['modfiles']);}return$this->docs_dir;}function updateMetas($HB){foreach($HB as$B=>$E){foreach($E as$F){$A=&$this->docs_dir->files[$B][$F];$A['slug']=$F;$A['url']=ltrim($B,'.').'/'.$F;$LB=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$LB->getMetaData());}}}function getMetadata($GB){if($GB===self::ADMIN_URLPRE){$GB=self::HOME_PAGE_URL;}$B='.'.rtrim(dirname($GB),'/');$F=basename($GB);$b=$this->getDocsDir();if(isset($b->files[$B])&&isset($b->files[$B][$F])){return$b->files[$B][$F];}}function dispatch(){$J=$this->linkage->getCurrURL(true);$c=false;if(empty($J)||in_array($J,array('/',self::HOME_PAGE_URL))){$J=self::HOME_PAGE_URL;}else if($J===self::ADMIN_URLPRE){$J=self::HOME_PAGE_URL;$c=true;}else if(starts_with($J,self::ADMIN_URLPRE.'/')){$J=substr($J,strlen(self::ADMIN_URLPRE));$c=true;}$A=$this->getMetadata($J);if(is_null($A)){die($J);}$s=new DOCX_View($this,$A,'',$c);return$s;}function run(){$DB=isset($_GET['action'])?$_GET['action']:false;if($DB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($DB==='staticize'){$this->genPages();return$this->gotoStaticIfCould();}else if($DB==='genpdf'){$JB=$this->genPDF();return$JB->send($this->getOption('title').'.pdf',true);}else if($DB==='publish'){$this->pubPages();}$this->dispatch()->output();}function gotoStaticIfCould(){if($T=$this->linkage->exchangeDir($this->public_dir,APP_ROOT)){$S=$this->getOption('urlext_html');return http_redirect($T.'/index'.$S);}}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$b=$this->getDocsDir();foreach($b->files as$B=>&$E){foreach($E as$F=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($N=false){$g=array('.',$this->linkage->getIndex());if(starts_with($this->document_dir,$this->public_dir)){$g[]=trim(substr($this->document_dir,strlen($this->public_dir)),'/');}DOCX_Directory::removeAll($this->public_dir,$g);if($N===false){$N=$this->public_dir;}$S=$this->getOption('urlext_html');$b=$this->getDocsDir();foreach($b->files as$B=>&$E){foreach($E as$F=>&$A){$i=$N.$A['url'].$S;$s=new DOCX_View($this,$A,'',false);$s->staticize($i);}}}function genPDF(){$JB=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$this->assets_dir.'/css/style.min.css','run-script'=>array($this->assets_dir.'/js/jquery.min.js',$this->assets_dir.'/js/highlight.min.js',$this->assets_dir.'/js/pdfscript.js',),));$NB=$this->getDocsDir();foreach($NB->files as$B=>&$E){foreach($E as$F=>&$A){if(self::isHome($A['slug'])){}else{$s=new DOCX_View($this,$A,'pdf.php',false);if($I=$s->getStaticContent()){$JB->addPage($I);}}}}return$JB;}function pubPages($VC='WebPub',$N=false){if($N===false){$N=$this->public_dir;}$XB=$this->getOption('publish_branch');if(!is_dir($N.'/.git')){$R=Git::create($N);$R->add('.');$R->commit('Init');$WC=$this->getOption('publish_repo');$R->run("remote add origin $WC");$R->run("checkout -b $XB");$ZC=$R->list_remote_branches();if(!empty($ZC)){$R->pull('origin',$XB);$this->genPages();}}$R=Git::open($N);$R->add('.');try{$R->commit($VC);}catch(Exception$yB){echo strval($yB);}return$R->push('origin',$XB);}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($H,&$r=null,&$mB=null){$this->setPath($H);$this->reader=$r;$this->writer=$mB;register_shutdown_function(function($YC){$YC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($H){$this->path=$H;return$this;}function connect(&$_B,$P=null){if(empty($P)){$this->data=&$_B;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$P]=&$_B;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$r=$this->getReader();$this->writer=&$r;}return$this->writer;}function load(&$DC=null){if($r=$this->getReader()){$C=$r->read($this->path);if(!is_null($C)){$this->data=$C;}if(!is_null($DC)){$this->changed=&$DC;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($mB=$this->getWriter()){$mB->write($this->path,$this->data);}return$this->data;}function offsetGet($FB){if(isset($this->data[$FB])){return$this->data[$FB];}}function offsetSet($FB,&$dB){$this->data[$FB]=$dB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($H='.',$EB=false,$U=self::ATTR_FILE_MTIME){$H=realpath($H);if(is_dir($H)){$this->dir=$H;$this->extname=$EB;}$this->attr_cmp=$U;}static function removeEmpty($B,$MC=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($B)){return 0;}$n=0;if($MC>=1||$MC>=mt_rand(1,10000)/10000){$E=scandir($B);if(is_array($E)&&count($E)===2){if($E[0]==='.'&&$E[1]==='..'){@rmdir($B);$n++;}}}return$n;}static function removeAll($B,array$g=array()){if(!file_exists($B)){return 0;}$n=0;$PC=scandir($B);foreach($PC as$V){if($g&&in_array($V,$g)){continue;}$gB=rtrim($B,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$V;if(is_dir($gB)){if($V==='.'||$V==='..'){continue;}self::removeAll($gB);}else{unlink($gB);$n++;}}if(!in_array('.',$g)){rmdir($B);}return$n;}static function eraseOrd($K,$iB='_',$CB=false){$K=$CB?basename($K,$CB):basename($K);$L=explode($iB,$K,2);if(count($L)===2&&is_numeric($L[0])){return$L[1];}return$K;}static function getAttrFunc($U){switch($U){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$E,$U,$hB=false){if(in_array($U,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$xB='return $a["'.$U.'"] - $b["'.$U.'"];';}else{$xB='return strcasecmp($a["'.$U.'"], $b["'.$U.'"]);';}$NC=$hB?'$b, $a':'$a, $b';uasort($E,create_function($NC,$xB));}function sortSubDir($_){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$OC=ltrim($_,'.');foreach($this->order_prefixes as$j){if(starts_with($OC,$j)){self::sortFiles($this->files[$_],$this->order_attr,$this->order_desc);}}}function setSorting(array$KC,$JC,$hB=false){if($KC&&$JC===$this->attr_cmp){$this->order_prefixes=$KC;$this->order_attr=$JC;$this->order_desc=$hB;}return$this;}function addCache($WB){$k=new DOCX_Cache($WB);$k->connect($this->files)->load($this->changed);return$this;}function scan(array&$E,$H,$j='.'){$CC=scandir($H);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($CC);}foreach($CC as$BB){if(substr($BB,0,1)==='.'){continue;}$V=$H.DIRECTORY_SEPARATOR.$BB;$EB='.'.pathinfo($BB,PATHINFO_EXTENSION);$FC=self::eraseOrd($BB,'_',$this->extname?$this->extname:$EB);if(is_dir($V)){$IC=$j.'/'.$FC;$E[$IC]=array();$this->scan($E,$V,$IC);}else if($this->extname===false||$this->extname===$EB){$uC=self::getAttrFunc($this->attr_cmp);$E[$j][$FC]=array('fname'=>$V,$this->attr_cmp=>$uC($V),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$_){$this->sortSubDir($_);}}}return$this->files;}function getDiffs(){$cB=array();$this->scan($cB,$this->dir);$M=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$M['deldirs']=array_diff(array_keys($this->files),array_keys($cB));if(!empty($M['deldirs'])){foreach($M['deldirs']as$B){unset($this->files[$B]);}$this->changed=true;}foreach($cB as$B=>&$E){$eB=isset($this->files[$B])?$this->files[$B]:array();if($kB=array_diff(array_keys($eB),array_keys($E))){$M['delfiles'][$B]=$kB;if(!empty($kB)){foreach($kB as$F){unset($this->files[$B][$F]);}$this->changed=true;}}$jB=array();$nB=array();foreach($E as$F=>&$lB){if(!isset($eB[$F])){$jB[]=$F;$this->files[$B][$F]=&$lB;}else if($lB[$this->attr_cmp]!==$eB[$F][$this->attr_cmp]){$nB[]=$F;$this->files[$B][$F]=&$lB;}}if(!empty($jB)){$M['addfiles'][$B]=$jB;$this->changed=true;}if(!empty($nB)){$M['modfiles'][$B]=$nB;$this->changed=true;}$this->sortSubDir($B);}return$M;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($D,$wC=false){assert(is_string($D));if($wC&&!is_file($D)){try{@mkdir(dirname($D),CACHE_DIR_MODE,true);@touch($D);@chmod($D,CACHE_FILE_MODE);}catch(\Exception$yB){return false;}}if($this->extname===false){$this->extname=pathinfo($D,PATHINFO_EXTENSION);}return$D;}function read($D,$vC=null){$C=null;if($D=$this->prepare($D,true)){$EC='_read'.$this->extname;if(method_exists($this,$EC)){$C=$this->$EC($D);}else{$C=$this->_read($D);}}return(is_null($C)||$C===false)?$vC:$C;}function write($D,&$C,$yC=0){if($D=$this->prepare($D,true)){$wB='_write'.$this->extname;if(method_exists($this,$wB)){return$this->$wB($D,$C);}else{return$this->_write($D,$C);}}}function delete($D){if($D=$this->prepare($D,false)){unlink($D);DOCX_Directory::unlinkEmpty(dirname($D));}}protected function _read($D){if($C=file_get_contents($D)){$AC='_unformat'.$this->extname;if(method_exists($this,$AC)){return$this->$AC($C);}else{return$C;}}}protected function _write($D,&$C,$yC=0){$t='_format'.$this->extname;if(method_exists($this,$t)){$I=$this->$t($C);}else{$I=$C;}return file_put_contents($D,$I,LOCK_EX);}protected function _readPHP($D){if(filesize($D)>0){return(include$D);}}protected function _formatPHP(&$C){return"<?php \nreturn ".var_export($C,true).";\n";}protected function _readCSV($D){$C=array();if(($O=fopen($D,'rb'))!==false){while(($QB=fgetcsv($O,0,$this->csv_delimiter))!==false){$C[]=$QB;}fclose($O);}return$C;}protected function _writeCSV($D,&$C){$zB=0;if(($O=fopen($D,'wb'))!==false){foreach($C as$QB){$zB+=fputcsv($O,$QB,$this->csv_delimiter);}fclose($O);}return$zB;}protected function _formatJSON(&$C){return json_encode($C);}protected function _unformatJSON(&$C){return json_decode($C,true);}protected function _formatYAML(&$C){if(extension_loaded('yaml')){return yaml_emit($C,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$cC=new Yaml\Dumper();return$cC->dump($C);}}protected function _unformatYAML(&$C){if(extension_loaded('yaml')){return yaml_parse($C);}else if(class_exists('Yaml\\Parser',true)){$dC=new Yaml\Parser();return$dC->parse($C);}}}class DOCX_Linkage{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$curr_url=false;protected$offset=0;protected$index='index.php';protected$route='q';function __construct($W,$hC=self::URL_TYPE_AUTO){$W=rtrim($W,'/');$this->url_type=intval($hC);if($this->isURLType('auto')){$this->abs_prefix=$this->fixPrefix($W);}else{$this->abs_prefix=$W;}}static function getConstant($K){return constant(__CLASS__.'::'.$K);}static function getRawURL(){$a=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($a)?'/':urldecode($a);}function isURLType($mC='query'){$lC='URL_TYPE_'.strtoupper($mC);return$this->url_type===$this->getConstant($lC);}function fixPrefix($W){$aB='!([a-zA-Z0-9_-]+\.php)!';if(preg_match($aB,$W,$RB,PREG_OFFSET_CAPTURE)){list($this->index,$kC)=$RB[0];$aB='!^\?([a-zA-Z0-9_-]+)=!';$y=substr($W,$kC+strlen($this->index));if(preg_match($aB,$y,$RB)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$RB[1];}else{$this->url_type=self::URL_TYPE_TAIL;}return rtrim($W,'?&');}else{$this->url_type=self::URL_TYPE_REWRITE;return rtrim($W,'/');}}function getCurrURL($jC=false){if($this->curr_url===false){if($this->isURLType('query')){$this->curr_url=isset($_GET[$this->route])?$_GET[$this->route]:'';$this->offset=-99;}else{$a=self::getRawURL();if($this->isURLType('rewrite')){$a=str_replace('/'.$this->index,'/',$a);$this->offset=-1;}$HC=strlen($this->getAbsPrefix());$this->curr_url=(strlen($a)>$HC)?substr($a,$HC):'';}}return$jC?rtrim($this->curr_url,'/'):$this->curr_url;}function getIndex(){return$this->index;}function getAbsPrefix(){return$this->abs_prefix;}function getRelPrefix($J=false){if($J===false){if($this->isURLType('query')){return'.';}$J=$this->getCurrURL(false);$SB=substr_count($J,'/')+$this->offset;}else{$SB=substr_count($J,'/');}return($SB>0)?rtrim(str_repeat('../',$SB),'/'):'.';}function buildQuery($x=''){if(is_string($x)){parse_str($x,$X);$x=array();}else{$X=array();}$X=array_merge($_GET,$x,$X);$y='?';if($this->isURLType('query')&&isset($X[$this->route])){$y=sprintf('?%s=%s&',$this->route,$X[$this->route]);unset($X[$this->route]);}return$y.(empty($X)?'':http_build_query($X).'&');}function exchangeDir($UB,$LC){$KB=self::getRawURL();if($this->isURLType('query')){$KB=dirname($KB);}list($VB,$q,$YB)=compare_pathes($UB,$LC);$T=null;if($q===0){$T=$KB;if($YB>0){$T.=substr($UB,strlen($LC));}}else if($q<=substr_count($KB,'/')){$T=rtrim(str_repeat('../',$q),'/');$T.=substr($UB,strlen($VB));}return$T;}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$htmldoc='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($h){$this->filename=$h;}static function getInstance($h){if(!isset(self::$instances[$h])){self::$instances[$h]=new self($h);}return self::$instances[$h];}static function parseMetaLine($G){$L=explode(':',$G);if(count($L)===2){$L[0]=strtolower(trim($L[0]));if(in_array($L[0],self::$meta_keys,true)){$L[1]=trim($L[1]);return$L;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($iC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->htmldoc='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$O=fopen($this->filename,'rb');if($O===false){return false;}$G=fgets($O);$G=$G?trim($G):'';$G=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$G);while(!$G||!trim($G));$PB=0;while($z=strlen($G)){$this->metatext.=$G."\n";if($z>=3&&$G===str_repeat('-',$z)){if($PB<=0){$PB=$z;}else if($PB===$z){$G='';break;}}else if($rB=self::parseMetaLine($G)){$A[$rB[0]]=$rB[1];}else{break;}$G=fgets($O);$G=$G?trim($G):'';}if($iC){$this->markdown=$G.fread($O,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$G;$this->headsize=ftell($O);}fclose($O);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($OB=false){if($this->headsize<0){$this->parseMetaData(false);}if($OB===false){return$this->metadata;}else if(isset($this->metadata[$OB])){return$this->metadata[$OB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$I=file_get_contents($this->filename);$this->markdown=substr($I,$this->headsize);$this->headsize=0;}if(!$this->htmldoc&&$this->markdown){$this->htmldoc=Parsedown::instance()->text($this->markdown);}$eC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'htmldoc'=>$this->htmldoc,);return array_merge($this->metadata,$eC);}function update($fC,$gC){$I=$fC."\n\n".$gC;file_put_contents($this->filename,$I,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($w,$nC=''){if($w){$this->setSourceDir($w);}$this->cache_dir=rtrim($nC,' /\\');}static function replaceWith($I,array$f=array(),$j='',$oC=''){if(!empty($f)){$qB=array();$oB=array();foreach($f as$P=>&$dB){$qB[]=$j.$P.$oC;$oB[]=$dB;}$I=str_replace($qB,$oB,$I);}return$I;}function setSourceDir($w){$this->source_dir=rtrim($w,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($AB,&$I){if(!isset($this->caches[$AB])){$k=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$AB);$this->caches[$AB]=&$k;}else{$k=&$this->caches[$AB];}$k->connect($I)->load();return$k;}function updateGlobals(array$xC){$this->globals=array_merge($this->globals,$xC);}function prepareFile($d){return$this->source_dir.'/'.$d;}function render($d,array$f=array(),$tB=false){$this->current_file=$d;if($tB){ob_start();}extract($this->globals);extract($f);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$pC=array_pop($this->extend_files);foreach($this->extend_files as$F){include$this->prepareFile($F);}extract($this->template_blocks);include$this->prepareFile($pC);}if($tB){$M=ob_get_clean();return$M?trim($M):'';}}function extendTpl($d){array_push($this->extend_files,$d);}function includeTpl($d,array$f=array(),$qC=false){extract($this->globals);extract($f);include$this->prepareFile($d);}function blockStart($rC='content',$qC=false){$this->current_block=$rC;ob_start();}function blockEnd(){$bC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$bC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($sC,array&$A,$Q='',$c=false){$this->app=$sC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($Q,$c);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($Q,$c=false){if(empty($Q)){if(isset($this->metadata['layout'])){$Q=$this->metadata['layout'];}if(empty($Q)){$Q=$this->app->getOption('layout');}$Q=($c?'edit/':'').$Q.'.php';}return is_readable($this->app->theme_dir.'/'.$Q)?$Q:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($m=false){if($m===false){$m=$this->app->public_dir;}$N=$m.'/assets';if(!file_exists($N)){$tC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';if(realpath($N)!==$this->app->assets_dir){@shell_exec($tC.' '.$this->app->assets_dir.' '.$N);}}}function getTemplater(){if(is_null($this->templater)){$NB=$this->app->getDocsDir();$this->templater=new DOCX_Templater($this->app->theme_dir,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$NB->files,);$this->ensureAssets($this->app->public_dir);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$LB=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$LB->update($_POST['metatext'],trim($_POST['markdown']));}$vB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$vB=$this->app->getToppestPage();}$l=$this->getTemplater();$l->globals['urlpre']=self::URL_PRE;$l->globals['urlext']=self::URL_EXT;$l->globals['assets_url']=self::URL_ASSETS;$l->globals['is_home']=$this->app->isHome($this->metadata['slug']);$this->content=$l->render($this->tpl_file,array('linkage'=>&$this->app->linkage,'page'=>$LB->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$vB,),true);}function output(){$this->renderPage();$S=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$S;$this->replacers[self::HTML_HIDE]='{}';$v=$this->app->linkage->getRelPrefix();$zC=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->linkage->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$v.'/assets';$I=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($I);}function getStaticContent(){$this->renderPage();$S=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$S;$this->replacers[self::HTML_HIDE]='{display: none}';$J=$this->metadata['url'].$S;$v=$this->app->linkage->getRelPrefix(ltrim($J,'/'));$this->replacers[self::URL_PRE]=$v;$this->replacers[self::URL_ASSETS]=$v.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($i=false){$m=$this->app->public_dir;if($i===false){$i=$m.$this->metadata['url'].$S;}@mkdir(dirname($i),0755,true);$I=$this->getStaticContent();return file_put_contents($i,$I,LOCK_EX);}}defined('APP_ROOT')or die('Illeigal access');function autoload_class($u){if(substr($u,0,5)==='DOCX_'){$H='DocX/'.substr($u,5).'.php';}else{$H=$u.'.php';}require_once DOCX_ROOT.'/library/'.$H;return class_exists($u,false);}function starts_with($MB,$p){return strncmp($MB,$p,strlen($p))===0;}function ends_with($MB,$p){$fB=strlen($p);return$fB===0||(strlen($MB)>=$fB&&substr_compare($MB,$p,-$fB)===0);}function convert($IB,$e='UTF-8'){$e=strtoupper($e);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($IB,$e,true)?$IB:mb_convert_encoding($IB,$e,'UTF-8, GBK');}else if(function_exists('iconv')){$aC=$e==='UTF-8'?'GBK':'UTF-8';return iconv($aC,$e.'//IGNORE',$IB);}}function http_redirect($T='',$XC=false){$QC=$XC?301:302;@header('Location: '.$T,true,$QC);return die();}function compare_pathes($Y,$Z){if($Y===$Z){return array($Y,0,0);}else if(starts_with($Y,$Z)){$YB=substr_count(substr($Y,strlen($Z)),'/');return array($Z,0,$YB);}else if(starts_with($Z,$Y)){$q=substr_count(substr($Z,strlen($Y)),'/');return array($Y,$q,0);}$sB=explode('/',$Z);$bB=explode('/',$Y);$uB=count($sB);foreach($bB as$o=>$RC){if($o>=$uB||$RC!==$sB[$o]){$VB=implode('/',array_slice($bB,0,$o));return array($VB,$uB-$o,count($bB)-$o);}}return array('',-1,-1);}function clean_ord($K,$CB='.md',$iB='_'){$K=basename($K,$CB);$L=explode($iB,$K,2);if(count($L)===2&&is_numeric($L[0])){return$L[1];}return$K;}function slugify($K){return strtolower(str_replace(' ','-',$K));}function rand_greeting($ZB){static$TB=0;if($TB===0){shuffle($ZB);$TB=count($ZB);}return$ZB[--$TB];}function zh_date($t,$UC=false){$M=date($t,$UC);if(strpos($t,'星期w')!==false){$pB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$M=str_replace(array_keys($pB),array_values($pB),$M);}return$M;}