<?php
class DOCX_App{const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$linkage=null;var$document_dir='';var$public_dir='';var$cache_dir='';var$theme_dir='';var$assets_dir='';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>9,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($CC=false){if(is_array($CC)){$this->options=array_merge($this->options,$CC);}$this->document_dir=self::getRealPath($this->getOption('document_dir'));$this->public_dir=self::getRealPath($this->getOption('public_dir'));$this->cache_dir=self::getRealPath($this->getOption('cache_dir'));$this->theme_dir=self::getRealPath($this->getOption('theme_dir'));$this->assets_dir=self::getRealPath($this->getOption('assets_dir'));$this->linkage=new DOCX_Linkage($this->getOption('url_prefix'),$this->getOption('url_type'));}static function getConstant($K){return constant(__CLASS__.'::'.$K);}static function getRealPath($B){$H=starts_with($B,'/')?$B:$H=DOCX_ROOT.'/'.$B;if(($JC=realpath($H))===false){@mkdir($H,0755,true);$JC=realpath($H);}return$JC;}static function isHome($OC){return$OC==='home';}function getOption($O=false){if($O===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$O])){return$_ENV[$O];}else if(isset($this->options[$O])){return$this->options[$O];}}function getDocsDir(){if(is_null($this->docs_dir)){$SB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($MC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($MC,DOCX_Directory::ATTR_FILE_MTIME,true);}$JB=$this->docs_dir->addCache($SB)->getDiffs();$this->updateMetas($JB['addfiles']);$this->updateMetas($JB['modfiles']);}return$this->docs_dir;}function updateMetas($JB){foreach($JB as$B=>$E){foreach($E as$F){$A=&$this->docs_dir->files[$B][$F];$A['slug']=$F;$A['url']=ltrim($B,'.').'/'.$F;$DB=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$DB->getMetaData());}}}function getMetadata($t){if($t===self::ADMIN_URLPRE){$t=self::HOME_PAGE_URL;}$B='.'.rtrim(dirname($t),'/');$F=basename($t);$c=$this->getDocsDir();if(isset($c->files[$B])&&isset($c->files[$B][$F])){return$c->files[$B][$F];}}function dispatch(){$J=$this->linkage->getCurrURL(true);$b=false;if(empty($J)||in_array($J,array('/',self::HOME_PAGE_URL))){$J=self::HOME_PAGE_URL;}else if($J===self::ADMIN_URLPRE){$J=self::HOME_PAGE_URL;$b=true;}else if(starts_with($J,self::ADMIN_URLPRE.'/')){$J=substr($J,strlen(self::ADMIN_URLPRE));$b=true;}$A=$this->getMetadata($J);if(is_null($A)){die($J);}$l=new DOCX_View($this,$A,'',$b);return$l;}function run(){$XB=isset($_GET['action'])?$_GET['action']:false;if($XB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($XB==='staticize'){$this->genPages();return$this->gotoStaticIfCould();}else if($XB==='genpdf'){$u=$this->genPDF();return$u->send($this->getOption('title').'.pdf',true);}$this->dispatch()->output();}function gotoStaticIfCould(){if($T=$this->linkage->exchangeDir($this->public_dir,APP_ROOT)){$S=$this->getOption('urlext_html');return http_redirect($T.'/index'.$S);}}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$c=$this->getDocsDir();foreach($c->files as$B=>&$E){foreach($E as$F=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($a=false){$i=array('.',$this->linkage->getIndex());if(starts_with($this->document_dir,$this->public_dir)){$i[]=trim(substr($this->document_dir,strlen($this->public_dir)),'/');}DOCX_Directory::removeAll($this->public_dir,$i);if($a===false){$a=$this->public_dir;}$S=$this->getOption('urlext_html');$c=$this->getDocsDir();foreach($c->files as$B=>&$E){foreach($E as$F=>&$A){$h=$a.$A['url'].$S;$l=new DOCX_View($this,$A,'',false);$l->staticize($h);}}}function genPDF(){$u=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$this->assets_dir.'/css/style.min.css','run-script'=>array($this->assets_dir.'/js/jquery.min.js',$this->assets_dir.'/js/highlight.min.js',$this->assets_dir.'/js/pdfscript.js',),));$MB=$this->getDocsDir();foreach($MB->files as$B=>&$E){foreach($E as$F=>&$A){if(self::isHome($A['slug'])){}else{$l=new DOCX_View($this,$A,'pdf.php',false);if($I=$l->getStaticContent()){$u->addPage($I);}}}}return$u;}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($H,&$m=null,&$dB=null){$this->setPath($H);$this->reader=$m;$this->writer=$dB;register_shutdown_function(function($UC){$UC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($H){$this->path=$H;return$this;}function connect(&$wB,$O=null){if(empty($O)){$this->data=&$wB;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$O]=&$wB;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$m=$this->getReader();$this->writer=&$m;}return$this->writer;}function load(&$uB=null){if($m=$this->getReader()){$C=$m->read($this->path);if(!is_null($C)){$this->data=$C;}if(!is_null($uB)){$this->changed=&$uB;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($dB=$this->getWriter()){$dB->write($this->path,$this->data);}return$this->data;}function offsetGet($GB){if(isset($this->data[$GB])){return$this->data[$GB];}}function offsetSet($GB,&$bB){$this->data[$GB]=$bB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($H='.',$KB=false,$R=self::ATTR_FILE_MTIME){$H=realpath($H);if(is_dir($H)){$this->dir=$H;$this->extname=$KB;}$this->attr_cmp=$R;}static function removeEmpty($B,$sB=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($B)){return 0;}$q=0;if($sB>=1||$sB>=mt_rand(1,10000)/10000){$E=scandir($B);if(is_array($E)&&count($E)===2){if($E[0]==='.'&&$E[1]==='..'){@rmdir($B);$q++;}}}return$q;}static function removeAll($B,array$i=array()){if(!file_exists($B)){return 0;}$q=0;$mC=scandir($B);foreach($mC as$U){if($i&&in_array($U,$i)){continue;}$aB=rtrim($B,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$U;if(is_dir($aB)){if($U==='.'||$U==='..'){continue;}self::removeAll($aB);}else{unlink($aB);$q++;}}if(!in_array('.',$i)){rmdir($B);}return$q;}static function eraseOrd($K,$QB='_',$HB=false){$K=$HB?basename($K,$HB):basename($K);$L=explode($QB,$K,2);if(count($L)===2&&is_numeric($L[0])){return$L[1];}return$K;}static function getAttrFunc($R){switch($R){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$E,$R,$WB=false){if(in_array($R,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$yB='return $a["'.$R.'"] - $b["'.$R.'"];';}else{$yB='return strcasecmp($a["'.$R.'"], $b["'.$R.'"]);';}$fC=$WB?'$b, $a':'$a, $b';uasort($E,create_function($fC,$yB));}function sortSubDir($IB){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$gC=ltrim($IB,'.');foreach($this->order_prefixes as$e){if(starts_with($gC,$e)){self::sortFiles($this->files[$IB],$this->order_attr,$this->order_desc);}}}function setSorting(array$FC,$EC,$WB=false){if($FC&&$EC===$this->attr_cmp){$this->order_prefixes=$FC;$this->order_attr=$EC;$this->order_desc=$WB;}return$this;}function addCache($SB){$d=new DOCX_Cache($SB);$d->connect($this->files)->load($this->changed);return$this;}function scan(array&$E,$H,$e='.'){$_B=scandir($H);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($_B);}foreach($_B as$FB){if(substr($FB,0,1)==='.'){continue;}$U=$H.DIRECTORY_SEPARATOR.$FB;$KB='.'.pathinfo($FB,PATHINFO_EXTENSION);$HC=self::eraseOrd($FB,'_',$this->extname?$this->extname:$KB);if(is_dir($U)){$mB=$e.'/'.$HC;$E[$mB]=array();$this->scan($E,$U,$mB);}else if($this->extname===false||$this->extname===$KB){$NC=self::getAttrFunc($this->attr_cmp);$E[$e][$HC]=array('fname'=>$U,$this->attr_cmp=>$NC($U),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$IB){$this->sortSubDir($IB);}}}return$this->files;}function getDiffs(){$LB=array();$this->scan($LB,$this->dir);$M=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$M['deldirs']=array_diff(array_keys($this->files),array_keys($LB));if(!empty($M['deldirs'])){foreach($M['deldirs']as$B){unset($this->files[$B]);}$this->changed=true;}foreach($LB as$B=>&$E){$hB=isset($this->files[$B])?$this->files[$B]:array();if($eB=array_diff(array_keys($hB),array_keys($E))){$M['delfiles'][$B]=$eB;if(!empty($eB)){foreach($eB as$F){unset($this->files[$B][$F]);}$this->changed=true;}}$PB=array();$jB=array();foreach($E as$F=>&$gB){if(!isset($hB[$F])){$PB[]=$F;$this->files[$B][$F]=&$gB;}else if($gB[$this->attr_cmp]!==$hB[$F][$this->attr_cmp]){$jB[]=$F;$this->files[$B][$F]=&$gB;}}if(!empty($PB)){$M['addfiles'][$B]=$PB;$this->changed=true;}if(!empty($jB)){$M['modfiles'][$B]=$jB;$this->changed=true;}$this->sortSubDir($B);}return$M;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($D,$XC=false){assert(is_string($D));if($XC&&!is_file($D)){try{@mkdir(dirname($D),CACHE_DIR_MODE,true);@touch($D);@chmod($D,CACHE_FILE_MODE);}catch(\Exception$uC){return false;}}if($this->extname===false){$this->extname=pathinfo($D,PATHINFO_EXTENSION);}return$D;}function read($D,$SC=null){$C=null;if($D=$this->prepare($D,true)){$GC='_read'.$this->extname;if(method_exists($this,$GC)){$C=$this->$GC($D);}else{$C=$this->_read($D);}}return(is_null($C)||$C===false)?$SC:$C;}function write($D,&$C,$TC=0){if($D=$this->prepare($D,true)){$zB='_write'.$this->extname;if(method_exists($this,$zB)){return$this->$zB($D,$C);}else{return$this->_write($D,$C);}}}function delete($D){if($D=$this->prepare($D,false)){unlink($D);DOCX_Directory::unlinkEmpty(dirname($D));}}protected function _read($D){if($C=file_get_contents($D)){$BC='_unformat'.$this->extname;if(method_exists($this,$BC)){return$this->$BC($C);}else{return$C;}}}protected function _write($D,&$C,$TC=0){$r='_format'.$this->extname;if(method_exists($this,$r)){$I=$this->$r($C);}else{$I=$C;}return file_put_contents($D,$I,LOCK_EX);}protected function _readPHP($D){if(filesize($D)>0){return(include$D);}}protected function _formatPHP(&$C){return"<?php \nreturn ".var_export($C,true).";\n";}protected function _readCSV($D){$C=array();if(($N=fopen($D,'rb'))!==false){while(($kB=fgetcsv($N,0,$this->csv_delimiter))!==false){$C[]=$kB;}fclose($N);}return$C;}protected function _writeCSV($D,&$C){$DC=0;if(($N=fopen($D,'wb'))!==false){foreach($C as$kB){$DC+=fputcsv($N,$kB,$this->csv_delimiter);}fclose($N);}return$DC;}protected function _formatJSON(&$C){return json_encode($C);}protected function _unformatJSON(&$C){return json_decode($C,true);}protected function _formatYAML(&$C){if(extension_loaded('yaml')){return yaml_emit($C,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$PC=new Yaml\Dumper();return$PC->dump($C);}}protected function _unformatYAML(&$C){if(extension_loaded('yaml')){return yaml_parse($C);}else if(class_exists('Yaml\\Parser',true)){$LC=new Yaml\Parser();return$LC->parse($C);}}}class DOCX_Linkage{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$curr_url=false;protected$offset=0;protected$index='index.php';protected$route='q';function __construct($Q,$oC=self::URL_TYPE_AUTO){$Q=rtrim($Q,'/');$this->url_type=intval($oC);if($this->isURLType('auto')){$this->abs_prefix=$this->fixPrefix($Q);}else{$this->abs_prefix=$Q;}}static function getConstant($K){return constant(__CLASS__.'::'.$K);}static function getRawURL(){$Z=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($Z)?'/':urldecode($Z);}function isURLType($qC='query'){$jC='URL_TYPE_'.strtoupper($qC);return$this->url_type===$this->getConstant($jC);}function fixPrefix($Q){$OB='!([a-zA-Z0-9_-]+\.php)!';if(preg_match($OB,$Q,$NB,PREG_OFFSET_CAPTURE)){list($this->index,$cC)=$NB[0];$OB='!^\?([a-zA-Z0-9_-]+)=!';$EB=substr($Q,$cC+strlen($this->index));if(preg_match($OB,$EB,$NB)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$NB[1];}else{$this->url_type=self::URL_TYPE_TAIL;}return rtrim($Q,'?&');}else{$this->url_type=self::URL_TYPE_REWRITE;return rtrim($Q,'/');}}function getCurrURL($bC=false){if($this->curr_url===false){if($this->isURLType('query')){$this->curr_url=isset($_GET[$this->route])?$_GET[$this->route]:'';$this->offset=-99;}else{$Z=self::getRawURL();if($this->isURLType('rewrite')){$Z=str_replace('/'.$this->index,'/',$Z);$this->offset=-1;}$AC=strlen($this->getAbsPrefix());$this->curr_url=(strlen($Z)>$AC)?substr($Z,$AC):'';}}return$bC?rtrim($this->curr_url,'/'):$this->curr_url;}function getIndex(){return$this->index;}function getAbsPrefix(){return$this->abs_prefix;}function getRelPrefix($J=false){if($J===false){if($this->isURLType('query')){return'.';}$J=$this->getCurrURL(false);$RB=substr_count($J,'/')+$this->offset;}else{$RB=substr_count($J,'/');}return($RB>0)?rtrim(str_repeat('../',$RB),'/'):'.';}function buildQuery($v=''){if(is_string($v)){parse_str($v,$V);$v=array();}else{$V=array();}$V=array_merge($_GET,$v,$V);$EB='?';if($this->isURLType('query')&&isset($V[$this->route])){$EB=sprintf('?%s=%s&',$this->route,$V[$this->route]);unset($V[$this->route]);}return$EB.(empty($V)?'':http_build_query($V).'&');}function exchangeDir($YB,$IC){$s=self::getRawURL();if($this->isURLType('query')){$s=dirname($s);}list($TB,$n,$UB)=compare_pathes($YB,$IC);$T=null;if($n===0){$T=$s;if($UB>0){$T.=substr($YB,strlen($IC));}}else if($n<=substr_count($s,'/')){$T=rtrim(str_repeat('../',$n),'/');$T.=substr($YB,strlen($TB));}return$T;}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$htmldoc='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($g){$this->filename=$g;}static function getInstance($g){if(!isset(self::$instances[$g])){self::$instances[$g]=new self($g);}return self::$instances[$g];}static function parseMetaLine($G){$L=explode(':',$G);if(count($L)===2){$L[0]=strtolower(trim($L[0]));if(in_array($L[0],self::$meta_keys,true)){$L[1]=trim($L[1]);return$L;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($nC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->htmldoc='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$N=fopen($this->filename,'rb');if($N===false){return false;}$G=fgets($N);$G=$G?trim($G):'';$G=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$G);while(!$G||!trim($G));$ZB=0;while($BB=strlen($G)){$this->metatext.=$G."\n";if($BB>=3&&$G===str_repeat('-',$BB)){if($ZB<=0){$ZB=$BB;}else if($ZB===$BB){$G='';break;}}else if($nB=self::parseMetaLine($G)){$A[$nB[0]]=$nB[1];}else{break;}$G=fgets($N);$G=$G?trim($G):'';}if($nC){$this->markdown=$G.fread($N,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$G;$this->headsize=ftell($N);}fclose($N);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($VB=false){if($this->headsize<0){$this->parseMetaData(false);}if($VB===false){return$this->metadata;}else if(isset($this->metadata[$VB])){return$this->metadata[$VB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$I=file_get_contents($this->filename);$this->markdown=substr($I,$this->headsize);$this->headsize=0;}if(!$this->htmldoc&&$this->markdown){$this->htmldoc=Parsedown::instance()->text($this->markdown);}$hC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'htmldoc'=>$this->htmldoc,);return array_merge($this->metadata,$hC);}function update($eC,$dC){$I=$eC."\n\n".$dC;file_put_contents($this->filename,$I,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($w,$ZC=''){if($w){$this->setSourceDir($w);}$this->cache_dir=rtrim($ZC,' /\\');}static function replaceWith($I,array$f=array(),$e='',$aC=''){if(!empty($f)){$qB=array();$vB=array();foreach($f as$O=>&$bB){$qB[]=$e.$O.$aC;$vB[]=$bB;}$I=str_replace($qB,$vB,$I);}return$I;}function setSourceDir($w){$this->source_dir=rtrim($w,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($_,&$I){if(!isset($this->caches[$_])){$d=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$_);$this->caches[$_]=&$d;}else{$d=&$this->caches[$_];}$d->connect($I)->load();return$d;}function updateGlobals(array$iC){$this->globals=array_merge($this->globals,$iC);}function prepareFile($Y){return$this->source_dir.'/'.$Y;}function render($Y,array$f=array(),$tB=false){$this->current_file=$Y;if($tB){ob_start();}extract($this->globals);extract($f);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$rC=array_pop($this->extend_files);foreach($this->extend_files as$F){include$this->prepareFile($F);}extract($this->template_blocks);include$this->prepareFile($rC);}if($tB){$M=ob_get_clean();return$M?trim($M):'';}}function extendTpl($Y){array_push($this->extend_files,$Y);}function includeTpl($Y,array$f=array(),$sC=false){extract($this->globals);extract($f);include$this->prepareFile($Y);}function blockStart($pC='content',$sC=false){$this->current_block=$pC;ob_start();}function blockEnd(){$kC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$kC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($lC,array&$A,$P='',$b=false){$this->app=$lC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($P,$b);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($P,$b=false){if(empty($P)){if(isset($this->metadata['layout'])){$P=$this->metadata['layout'];}if(empty($P)){$P=$this->app->getOption('layout');}$P=($b?'edit/':'').$P.'.php';}return is_readable($this->app->theme_dir.'/'.$P)?$P:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($p=false){if($p===false){$p=$this->app->public_dir;}$a=$p.'/assets';if(!file_exists($a)){$YC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';if(realpath($a)!==$this->app->assets_dir){@shell_exec($YC.' '.$this->app->assets_dir.' '.$a);}}}function getTemplater(){if(is_null($this->templater)){$MB=$this->app->getDocsDir();$this->templater=new DOCX_Templater($this->app->theme_dir,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$MB->files,);$this->ensureAssets($this->app->public_dir);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$DB=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$DB->update($_POST['metatext'],trim($_POST['markdown']));}$rB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$rB=$this->app->getToppestPage();}$y=$this->getTemplater();$y->globals['urlpre']=self::URL_PRE;$y->globals['urlext']=self::URL_EXT;$y->globals['assets_url']=self::URL_ASSETS;$this->content=$y->render($this->tpl_file,array('linkage'=>&$this->app->linkage,'page'=>$DB->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$rB,),true);}function output(){$this->renderPage();$S=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$S;$this->replacers[self::HTML_HIDE]='{}';$CB=$this->app->linkage->getRelPrefix();$tC=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->linkage->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$CB.'/assets';$I=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($I);}function getStaticContent(){$this->renderPage();$S=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$S;$this->replacers[self::HTML_HIDE]='{display: none}';$J=$this->metadata['url'].$S;$CB=$this->app->linkage->getRelPrefix(ltrim($J,'/'));$this->replacers[self::URL_PRE]=$CB;$this->replacers[self::URL_ASSETS]=$CB.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($h=false){$p=$this->app->public_dir;if($h===false){$h=$p.$this->metadata['url'].$S;}@mkdir(dirname($h),0755,true);$I=$this->getStaticContent();return file_put_contents($h,$I,LOCK_EX);}}defined('APP_ROOT')or die('Illeigal access');function autoload_class($AB){if(substr($AB,0,5)==='DOCX_'){$H='DocX/'.substr($AB,5).'.php';}else{$H=$AB.'.php';}require_once DOCX_ROOT.'/library/'.$H;return class_exists($AB,false);}function starts_with($z,$o){return strncmp($z,$o,strlen($o))===0;}function ends_with($z,$o){$lB=strlen($o);return$lB===0||(strlen($z)>=$lB&&substr_compare($z,$o,-$lB)===0);}function convert($x,$j='UTF-8'){$j=strtoupper($j);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($x,$j,true)?$x:mb_convert_encoding($x,$j,'UTF-8, GBK');}else if(function_exists('iconv')){$QC=$j==='UTF-8'?'GBK':'UTF-8';return iconv($QC,$j.'//IGNORE',$x);}}function http_redirect($T='',$VC=false){$WC=$VC?301:302;@header('Location: '.$T,true,$WC);return die();}function compare_pathes($W,$X){if($W===$X){return array($W,0,0);}else if(starts_with($W,$X)){$UB=substr_count(substr($W,strlen($X)),'/');return array($X,0,$UB);}else if(starts_with($X,$W)){$n=substr_count(substr($X,strlen($W)),'/');return array($W,$n,0);}$xB=explode('/',$X);$fB=explode('/',$W);$pB=count($xB);foreach($fB as$k=>$RC){if($k>=$pB||$RC!==$xB[$k]){$TB=implode('/',array_slice($fB,0,$k));return array($TB,$pB-$k,count($fB)-$k);}}return array('',-1,-1);}function clean_ord($K,$HB='.md',$QB='_'){$K=basename($K,$HB);$L=explode($QB,$K,2);if(count($L)===2&&is_numeric($L[0])){return$L[1];}return$K;}function slugify($K){return strtolower(str_replace(' ','-',$K));}function rand_greeting($cB){static$iB=0;if($iB===0){shuffle($cB);$iB=count($cB);}return$cB[--$iB];}function zh_date($r,$KC=false){$M=date($r,$KC);if(strpos($r,'星期w')!==false){$oB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$M=str_replace(array_keys($oB),array_values($oB),$M);}return$M;}