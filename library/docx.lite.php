<?php
class DOCX_App{const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$linkage=null;var$document_dir='';var$public_dir='';var$cache_dir='';var$theme_dir='';var$assets_dir='';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>9,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','publish_branch'=>false,'publish_repo'=>false,'github_repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',),'files'=>array(),),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($AC=false){if(is_array($AC)){$this->options=array_merge($this->options,$AC);}$this->document_dir=self::getRealPath($this->getOption('document_dir'));$this->public_dir=self::getRealPath($this->getOption('public_dir'));$this->cache_dir=self::getRealPath($this->getOption('cache_dir'));$this->theme_dir=self::getRealPath($this->getOption('theme_dir'));$this->assets_dir=self::getRealPath($this->getOption('assets_dir'));$this->linkage=new DOCX_Linkage($this->getOption('url_prefix'),$this->getOption('url_type'));}static function getConstant($K){return constant(__CLASS__.'::'.$K);}static function getRealPath($B){$H=starts_with($B,'/')?$B:$H=DOCX_ROOT.'/'.$B;if(($JC=realpath($H))===false){@mkdir($H,0755,true);$JC=realpath($H);}return$JC;}static function isHome($UC){return$UC==='home';}function getOption($Q=false){if($Q===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$Q])){return$_ENV[$Q];}else if(isset($this->options[$Q])){return$this->options[$Q];}}function getDocsDir(){if(is_null($this->docs_dir)){$gB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($TC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($TC,DOCX_Directory::ATTR_FILE_MTIME,true);}$JB=$this->docs_dir->addCache($gB)->getDiffs();$this->updateMetas($JB['addfiles']);$this->updateMetas($JB['modfiles']);}return$this->docs_dir;}function updateMetas($JB){foreach($JB as$B=>$E){foreach($E as$G){$A=&$this->docs_dir->files[$B][$G];$A['slug']=$G;$A['url']=ltrim($B,'.').'/'.$G;$BB=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$BB->getMetaData());}}}function getMetadata($MB){if($MB===self::ADMIN_URLPRE){$MB=self::HOME_PAGE_URL;}$B='.'.rtrim(dirname($MB),'/');$G=basename($MB);$b=$this->getDocsDir();if(isset($b->files[$B])&&isset($b->files[$B][$G])){return$b->files[$B][$G];}}function dispatch(){$J=$this->linkage->getCurrURL(true);$a=false;if(empty($J)||in_array($J,array('/',self::HOME_PAGE_URL))){$J=self::HOME_PAGE_URL;}else if($J===self::ADMIN_URLPRE){$J=self::HOME_PAGE_URL;$a=true;}else if(starts_with($J,self::ADMIN_URLPRE.'/')){$J=substr($J,strlen(self::ADMIN_URLPRE));$a=true;}$A=$this->getMetadata($J);if(is_null($A)){die($J);}$p=new DOCX_View($this,$A,'',$a);return$p;}function run(){$KB=isset($_GET['action'])?$_GET['action']:false;if($KB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($KB==='staticize'){$this->genPages();return$this->gotoStaticIfCould();}else if($KB==='genpdf'){$HB=$this->genPDF();return$HB->send($this->getOption('title').'.pdf',true);}else if($KB==='publish'){$this->pubPages();}$this->dispatch()->output();}function gotoStaticIfCould(){if($T=$this->linkage->exchangeDir($this->public_dir,APP_ROOT)){$S=$this->getOption('urlext_html');return http_redirect($T.'/index'.$S);}}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$b=$this->getDocsDir();foreach($b->files as$B=>&$E){foreach($E as$G=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($N=false){$X=array('.',$this->linkage->getIndex());if(starts_with($this->document_dir,$this->public_dir)){$X[]=trim(substr($this->document_dir,strlen($this->public_dir)),'/');}if($NC=$this->getOption('ignore')){$X=array_merge($X,$NC['folders'],$NC['files']);}DOCX_Directory::removeAll($this->public_dir,$X);if($N===false){$N=$this->public_dir;}$S=$this->getOption('urlext_html');$b=$this->getDocsDir();foreach($b->files as$B=>&$E){foreach($E as$G=>&$A){$i=$N.$A['url'].$S;$p=new DOCX_View($this,$A,'',false);$p->staticize($i);}}}function genPDF(){$HB=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$this->assets_dir.'/css/style.min.css','run-script'=>array($this->assets_dir.'/js/jquery.min.js',$this->assets_dir.'/js/highlight.min.js',$this->assets_dir.'/js/pdfscript.js',),));$XB=$this->getDocsDir();foreach($XB->files as$B=>&$E){foreach($E as$G=>&$A){if(self::isHome($A['slug'])){}else{$p=new DOCX_View($this,$A,'pdf.php',false);if($I=$p->getStaticContent()){$HB->addPage($I);}}}}return$HB;}function pubPages($WC='WebPub',$N=false){if($N===false){$N=$this->public_dir;}$fB=$this->getOption('publish_branch');if(!is_dir($N.'/.git')){$P=Git::create($N);$P->add('.');$P->commit('Init');$XC=$this->getOption('publish_repo');$P->run("remote add origin $XC");$P->run("checkout -b $fB");$aC=$P->list_remote_branches();if(!empty($aC)){$P->pull('origin',$fB);$this->genPages();}}$P=Git::open($N);$P->add('.');try{$P->commit($WC);}catch(Exception$zB){echo strval($zB);}return$P->push('origin',$fB);}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($H,&$q=null,&$dB=null){$this->setPath($H);$this->reader=$q;$this->writer=$dB;register_shutdown_function(function($ZC){$ZC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($H){$this->path=$H;return$this;}function connect(&$CC,$Q=null){if(empty($Q)){$this->data=&$CC;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$Q]=&$CC;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$q=$this->getReader();$this->writer=&$q;}return$this->writer;}function load(&$MC=null){if($q=$this->getReader()){$C=$q->read($this->path);if(!is_null($C)){$this->data=$C;}if(!is_null($MC)){$this->changed=&$MC;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($dB=$this->getWriter()){$dB->write($this->path,$this->data);}return$this->data;}function offsetGet($GB){if(isset($this->data[$GB])){return$this->data[$GB];}}function offsetSet($GB,&$eB){$this->data[$GB]=$eB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($H='.',$CB=false,$V=self::ATTR_FILE_MTIME){$H=realpath($H);if(is_dir($H)){$this->dir=$H;$this->extname=$CB;}$this->attr_cmp=$V;}static function removeEmpty($B,$EC=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($B)){return 0;}$r=0;if($EC>=1||$EC>=mt_rand(1,10000)/10000){$E=scandir($B);if(is_array($E)&&count($E)===2){if($E[0]==='.'&&$E[1]==='..'){@rmdir($B);$r++;}}}return$r;}static function removeAll($B,array$X=array()){if(!file_exists($B)){return 0;}$r=0;$QC=scandir($B);foreach($QC as$U){if($X&&in_array($U,$X)){continue;}$aB=rtrim($B,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$U;if(is_dir($aB)){if($U==='.'||$U==='..'){continue;}self::removeAll($aB);}else{unlink($aB);$r++;}}if(!in_array('.',$X)){rmdir($B);}return$r;}static function eraseOrd($K,$WB='_',$LB=false){$K=$LB?basename($K,$LB):basename($K);$L=explode($WB,$K,2);if(count($L)===2&&is_numeric($L[0])){return$L[1];}return$K;}static function getAttrFunc($V){switch($V){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$E,$V,$YB=false){if(in_array($V,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$_B='return $a["'.$V.'"] - $b["'.$V.'"];';}else{$_B='return strcasecmp($a["'.$V.'"], $b["'.$V.'"]);';}$OC=$YB?'$b, $a':'$a, $b';uasort($E,create_function($OC,$_B));}function sortSubDir($v){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$PC=ltrim($v,'.');foreach($this->order_prefixes as$g){if(starts_with($PC,$g)){self::sortFiles($this->files[$v],$this->order_attr,$this->order_desc);}}}function setSorting(array$KC,$BC,$YB=false){if($KC&&$BC===$this->attr_cmp){$this->order_prefixes=$KC;$this->order_attr=$BC;$this->order_desc=$YB;}return$this;}function addCache($gB){$f=new DOCX_Cache($gB);$f->connect($this->files)->load($this->changed);return$this;}function scan(array&$E,$H,$g='.'){$IC=scandir($H);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($IC);}foreach($IC as$AB){if(substr($AB,0,1)==='.'){continue;}$U=$H.DIRECTORY_SEPARATOR.$AB;$CB='.'.pathinfo($AB,PATHINFO_EXTENSION);$HC=self::eraseOrd($AB,'_',$this->extname?$this->extname:$CB);if(is_dir($U)){$yB=$g.'/'.$HC;$E[$yB]=array();$this->scan($E,$U,$yB);}else if($this->extname===false||$this->extname===$CB){$vC=self::getAttrFunc($this->attr_cmp);$E[$g][$HC]=array('fname'=>$U,$this->attr_cmp=>$vC($U),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$v){$this->sortSubDir($v);}}}return$this->files;}function getDiffs(){$mB=array();$this->scan($mB,$this->dir);$M=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$M['deldirs']=array_diff(array_keys($this->files),array_keys($mB));if(!empty($M['deldirs'])){foreach($M['deldirs']as$B){unset($this->files[$B]);}$this->changed=true;}foreach($mB as$B=>&$E){$nB=isset($this->files[$B])?$this->files[$B]:array();if($lB=array_diff(array_keys($nB),array_keys($E))){$M['delfiles'][$B]=$lB;if(!empty($lB)){foreach($lB as$G){unset($this->files[$B][$G]);}$this->changed=true;}}$kB=array();$hB=array();foreach($E as$G=>&$iB){if(!isset($nB[$G])){$kB[]=$G;$this->files[$B][$G]=&$iB;}else if($iB[$this->attr_cmp]!==$nB[$G][$this->attr_cmp]){$hB[]=$G;$this->files[$B][$G]=&$iB;}}if(!empty($kB)){$M['addfiles'][$B]=$kB;$this->changed=true;}if(!empty($hB)){$M['modfiles'][$B]=$hB;$this->changed=true;}$this->sortSubDir($B);}return$M;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($D,$yC=false){assert(is_string($D));if($yC&&!is_file($D)){try{@mkdir(dirname($D),CACHE_DIR_MODE,true);@touch($D);@chmod($D,CACHE_FILE_MODE);}catch(\Exception$zB){return false;}}if($this->extname===false){$this->extname=pathinfo($D,PATHINFO_EXTENSION);}return$D;}function read($D,$wC=null){$C=null;if($D=$this->prepare($D,true)){$DC='_read'.$this->extname;if(method_exists($this,$DC)){$C=$this->$DC($D);}else{$C=$this->_read($D);}}return(is_null($C)||$C===false)?$wC:$C;}function write($D,&$C,$pC=0){if($D=$this->prepare($D,true)){$xB='_write'.$this->extname;if(method_exists($this,$xB)){return$this->$xB($D,$C);}else{return$this->_write($D,$C);}}}function delete($D){if($D=$this->prepare($D,false)){unlink($D);DOCX_Directory::unlinkEmpty(dirname($D));}}protected function _read($D){if($C=file_get_contents($D)){$FC='_unformat'.$this->extname;if(method_exists($this,$FC)){return$this->$FC($C);}else{return$C;}}}protected function _write($D,&$C,$pC=0){$t='_format'.$this->extname;if(method_exists($this,$t)){$I=$this->$t($C);}else{$I=$C;}return file_put_contents($D,$I,LOCK_EX);}protected function _readPHP($D){if(filesize($D)>0){return(include$D);}}protected function _formatPHP(&$C){return"<?php \nreturn ".var_export($C,true).";\n";}protected function _readCSV($D){$C=array();if(($O=fopen($D,'rb'))!==false){while(($VB=fgetcsv($O,0,$this->csv_delimiter))!==false){$C[]=$VB;}fclose($O);}return$C;}protected function _writeCSV($D,&$C){$GC=0;if(($O=fopen($D,'wb'))!==false){foreach($C as$VB){$GC+=fputcsv($O,$VB,$this->csv_delimiter);}fclose($O);}return$GC;}protected function _formatJSON(&$C){return json_encode($C);}protected function _unformatJSON(&$C){return json_decode($C,true);}protected function _formatYAML(&$C){if(extension_loaded('yaml')){return yaml_emit($C,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$dC=new Yaml\Dumper();return$dC->dump($C);}}protected function _unformatYAML(&$C){if(extension_loaded('yaml')){return yaml_parse($C);}else if(class_exists('Yaml\\Parser',true)){$eC=new Yaml\Parser();return$eC->parse($C);}}}class DOCX_Linkage{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$curr_url=false;protected$offset=0;protected$index='index.php';protected$route='q';function __construct($W,$jC=self::URL_TYPE_AUTO){$W=rtrim($W,'/');$this->url_type=intval($jC);if($this->isURLType('auto')){$this->abs_prefix=$this->fixPrefix($W);}else{$this->abs_prefix=$W;}}static function getConstant($K){return constant(__CLASS__.'::'.$K);}static function getRawURL(){$e=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($e)?'/':urldecode($e);}function isURLType($nC='query'){$mC='URL_TYPE_'.strtoupper($nC);return$this->url_type===$this->getConstant($mC);}function fixPrefix($W){$QB='!([a-zA-Z0-9_-]+\.php)!';if(preg_match($QB,$W,$OB,PREG_OFFSET_CAPTURE)){list($this->index,$lC)=$OB[0];$QB='!^\?([a-zA-Z0-9_-]+)=!';$FB=substr($W,$lC+strlen($this->index));if(preg_match($QB,$FB,$OB)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$OB[1];}else{$this->url_type=self::URL_TYPE_TAIL;}return rtrim($W,'?&');}else{$this->url_type=self::URL_TYPE_REWRITE;return rtrim($W,'/');}}function getCurrURL($kC=false){if($this->curr_url===false){if($this->isURLType('query')){$this->curr_url=isset($_GET[$this->route])?$_GET[$this->route]:'';$this->offset=-99;}else{$e=self::getRawURL();if($this->isURLType('rewrite')){$e=str_replace('/'.$this->index,'/',$e);$this->offset=-1;}$LC=strlen($this->getAbsPrefix());$this->curr_url=(strlen($e)>$LC)?substr($e,$LC):'';}}return$kC?rtrim($this->curr_url,'/'):$this->curr_url;}function getIndex(){return$this->index;}function getAbsPrefix(){return$this->abs_prefix;}function getRelPrefix($J=false){if($J===false){if($this->isURLType('query')){return'.';}$J=$this->getCurrURL(false);$RB=substr_count($J,'/')+$this->offset;}else{$RB=substr_count($J,'/');}return($RB>0)?rtrim(str_repeat('../',$RB),'/'):'.';}function buildQuery($y=''){if(is_string($y)){parse_str($y,$Z);$y=array();}else{$Z=array();}$Z=array_merge($_GET,$y,$Z);$FB='?';if($this->isURLType('query')&&isset($Z[$this->route])){$FB=sprintf('?%s=%s&',$this->route,$Z[$this->route]);unset($Z[$this->route]);}return$FB.(empty($Z)?'':http_build_query($Z).'&');}function exchangeDir($PB,$qB){$z=self::getRawURL();if($this->isURLType('query')){$z=dirname($z);}list($TB,$o,$UB)=compare_pathes($PB,$qB);$T=null;if($o===0){$T=$z;if($UB>0){$T.=substr($PB,strlen($qB));}}else if($o<=substr_count($z,'/')){$T=rtrim(str_repeat('../',$o),'/');$T.=substr($PB,strlen($TB));}return$T;}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$htmldoc='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($h){$this->filename=$h;}static function getInstance($h){if(!isset(self::$instances[$h])){self::$instances[$h]=new self($h);}return self::$instances[$h];}static function parseMetaLine($F){$L=explode(':',$F);if(count($L)===2){$L[0]=strtolower(trim($L[0]));if(in_array($L[0],self::$meta_keys,true)){$L[1]=trim($L[1]);return$L;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($iC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->htmldoc='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$O=fopen($this->filename,'rb');if($O===false){return false;}$F=fgets($O);$F=$F?trim($F):'';$F=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$F);while(!$F||!trim($F));$SB=0;while($w=strlen($F)){$this->metatext.=$F."\n";if($w>=3&&$F===str_repeat('-',$w)){if($SB<=0){$SB=$w;}else if($SB===$w){$F='';break;}}else if($rB=self::parseMetaLine($F)){$A[$rB[0]]=$rB[1];}else{break;}$F=fgets($O);$F=$F?trim($F):'';}if($iC){$this->markdown=$F.fread($O,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$F;$this->headsize=ftell($O);}fclose($O);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($NB=false){if($this->headsize<0){$this->parseMetaData(false);}if($NB===false){return$this->metadata;}else if(isset($this->metadata[$NB])){return$this->metadata[$NB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$I=file_get_contents($this->filename);$this->markdown=substr($I,$this->headsize);$this->headsize=0;}if(!$this->htmldoc&&$this->markdown){$this->htmldoc=Parsedown::instance()->text($this->markdown);}$fC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'htmldoc'=>$this->htmldoc,);return array_merge($this->metadata,$fC);}function update($gC,$hC){$I=$gC."\n\n".$hC;file_put_contents($this->filename,$I,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($x,$oC=''){if($x){$this->setSourceDir($x);}$this->cache_dir=rtrim($oC,' /\\');}static function replaceWith($I,array$k=array(),$g='',$zC=''){if(!empty($k)){$sB=array();$vB=array();foreach($k as$Q=>&$eB){$sB[]=$g.$Q.$zC;$vB[]=$eB;}$I=str_replace($sB,$vB,$I);}return$I;}function setSourceDir($x){$this->source_dir=rtrim($x,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($IB,&$I){if(!isset($this->caches[$IB])){$f=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$IB);$this->caches[$IB]=&$f;}else{$f=&$this->caches[$IB];}$f->connect($I)->load();return$f;}function updateGlobals(array$xC){$this->globals=array_merge($this->globals,$xC);}function prepareFile($c){return$this->source_dir.'/'.$c;}function render($c,array$k=array(),$tB=false){$this->current_file=$c;if($tB){ob_start();}extract($this->globals);extract($k);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$qC=array_pop($this->extend_files);foreach($this->extend_files as$G){include$this->prepareFile($G);}extract($this->template_blocks);include$this->prepareFile($qC);}if($tB){$M=ob_get_clean();return$M?trim($M):'';}}function extendTpl($c){array_push($this->extend_files,$c);}function includeTpl($c,array$k=array(),$rC=false){extract($this->globals);extract($k);include$this->prepareFile($c);}function blockStart($sC='content',$rC=false){$this->current_block=$sC;ob_start();}function blockEnd(){$cC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$cC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($tC,array&$A,$R='',$a=false){$this->app=$tC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($R,$a);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($R,$a=false){if(empty($R)){if(isset($this->metadata['layout'])){$R=$this->metadata['layout'];}if(empty($R)){$R=$this->app->getOption('layout');}$R=($a?'edit/':'').$R.'.php';}return is_readable($this->app->theme_dir.'/'.$R)?$R:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($n=false){if($n===false){$n=$this->app->public_dir;}$N=$n.'/assets';if(!file_exists($N)){$uC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';if(realpath($N)!==$this->app->assets_dir){@shell_exec($uC.' '.$this->app->assets_dir.' '.$N);}}}function getTemplater(){if(is_null($this->templater)){$XB=$this->app->getDocsDir();$this->templater=new DOCX_Templater($this->app->theme_dir,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$XB->files,);$this->ensureAssets($this->app->public_dir);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$BB=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$BB->update($_POST['metatext'],trim($_POST['markdown']));}$uB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$uB=$this->app->getToppestPage();}$l=$this->getTemplater();$l->globals['urlpre']=self::URL_PRE;$l->globals['urlext']=self::URL_EXT;$l->globals['assets_url']=self::URL_ASSETS;$l->globals['is_home']=$this->app->isHome($this->metadata['slug']);$this->content=$l->render($this->tpl_file,array('linkage'=>&$this->app->linkage,'page'=>$BB->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$uB,),true);}function output(){$this->renderPage();$S=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$S;$this->replacers[self::HTML_HIDE]='{}';$u=$this->app->linkage->getRelPrefix();$_C=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->linkage->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$u.'/assets';$I=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($I);}function getStaticContent(){$this->renderPage();$S=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$S;$this->replacers[self::HTML_HIDE]='{display: none}';$J=$this->metadata['url'].$S;$u=$this->app->linkage->getRelPrefix(ltrim($J,'/'));$this->replacers[self::URL_PRE]=$u;$this->replacers[self::URL_ASSETS]=$u.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($i=false){$n=$this->app->public_dir;if($i===false){$i=$n.$this->metadata['url'].$S;}@mkdir(dirname($i),0755,true);$I=$this->getStaticContent();return file_put_contents($i,$I,LOCK_EX);}}defined('APP_ROOT')or die('Illeigal access');function autoload_class($_){if(substr($_,0,5)==='DOCX_'){$H='DocX/'.substr($_,5).'.php';}else{$H=$_.'.php';}require_once DOCX_ROOT.'/library/'.$H;return class_exists($_,false);}function starts_with($EB,$s){return strncmp($EB,$s,strlen($s))===0;}function ends_with($EB,$s){$bB=strlen($s);return$bB===0||(strlen($EB)>=$bB&&substr_compare($EB,$s,-$bB)===0);}function convert($DB,$j='UTF-8'){$j=strtoupper($j);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($DB,$j,true)?$DB:mb_convert_encoding($DB,$j,'UTF-8, GBK');}else if(function_exists('iconv')){$bC=$j==='UTF-8'?'GBK':'UTF-8';return iconv($bC,$j.'//IGNORE',$DB);}}function http_redirect($T='',$YC=false){$RC=$YC?301:302;@header('Location: '.$T,true,$RC);return die();}function compare_pathes($Y,$d){if($Y===$d){return array($Y,0,0);}else if(starts_with($Y,$d)){$UB=substr_count(substr($Y,strlen($d)),'/');return array($d,0,$UB);}else if(starts_with($d,$Y)){$o=substr_count(substr($d,strlen($Y)),'/');return array($Y,$o,0);}$wB=explode('/',$d);$cB=explode('/',$Y);$pB=count($wB);foreach($cB as$m=>$SC){if($m>=$pB||$SC!==$wB[$m]){$TB=implode('/',array_slice($cB,0,$m));return array($TB,$pB-$m,count($cB)-$m);}}return array('',-1,-1);}function clean_ord($K,$LB='.md',$WB='_'){$K=basename($K,$LB);$L=explode($WB,$K,2);if(count($L)===2&&is_numeric($L[0])){return$L[1];}return$K;}function slugify($K){return strtolower(str_replace(' ','-',$K));}function rand_greeting($ZB){static$jB=0;if($jB===0){shuffle($ZB);$jB=count($ZB);}return$ZB[--$jB];}function zh_date($t,$VC=false){$M=date($t,$VC);if(strpos($t,'星期w')!==false){$oB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$M=str_replace(array_keys($oB),array_values($oB),$M);}return$M;}