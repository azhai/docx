<?php
class DOCX_App{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$document_dir='';var$public_dir='';var$cache_dir='';var$theme_dir='';var$assets_dir='';protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$offset=0;protected$index='index.php';protected$route='r';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>self::URL_TYPE_AUTO,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($vB=false){if(is_array($vB)){$this->options=array_merge($this->options,$vB);}$this->document_dir=self::getRealPath($this->getOption('document_dir'));$this->public_dir=self::getRealPath($this->getOption('public_dir'));$this->cache_dir=self::getRealPath($this->getOption('cache_dir'));$this->theme_dir=self::getRealPath($this->getOption('theme_dir'));$this->assets_dir=self::getRealPath($this->getOption('assets_dir'));$this->abs_prefix=$this->getAbsPrefix();}static function getRealPath($B){$I=starts_with($B,'/')?$B:$I=DOCX_ROOT.'/'.$B;if(($nB=realpath($I))===false){@mkdir($I,0755,true);$nB=realpath($I);}return$nB;}static function isHome($KC){return$KC==='home';}static function getRawURL(){$Z=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($Z)?'/':urldecode($Z);}function getConstant($L){return constant(__CLASS__.'::'.$L);}function getOption($P=false){if($P===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$P])){return$_ENV[$P];}else if(isset($this->options[$P])){return$this->options[$P];}}function getAbsPrefix(){if($this->abs_prefix!==false){return$this->abs_prefix;}$this->url_type=intval($this->getOption('url_type'));$this->abs_prefix=rtrim($this->getOption('url_prefix'),'/');$GC=array(self::URL_TYPE_QUERY,self::URL_TYPE_TAIL,self::URL_TYPE_REWRITE);if(!in_array($this->url_type,$GC)){$this->url_type=$this->fixURLType();}return$this->abs_prefix;}function fixURLType(){$QB='!([a-zA-Z0-9_-]+\.php)!';if(preg_match($QB,$this->abs_prefix,$UB,PREG_OFFSET_CAPTURE)){list($this->index,$AC)=$UB[0];$QB='!^\?([a-zA-Z0-9_-]+)=!';$RB=substr($this->abs_prefix,$AC+strlen($this->index));if(preg_match($QB,$RB,$UB)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$UB[1];}else{$this->url_type=self::URL_TYPE_TAIL;}$this->abs_prefix=rtrim($this->abs_prefix,'?&');}else{$this->url_type=self::URL_TYPE_REWRITE;$this->abs_prefix=rtrim($this->abs_prefix,'/');}return$this->url_type;}function getCurrURL($EC=false){$Z=self::getRawURL();if($this->url_type===self::URL_TYPE_QUERY){$E='';if(isset($_GET[$this->route])){$E='/'.trim($_GET[$this->route],'/').'/';}$this->offset=-99;}else{if($this->url_type===self::URL_TYPE_REWRITE){$Z=str_replace('/'.$this->index,'/',$Z);$this->offset=-1;}$fB=strlen($this->getAbsPrefix());$E=(strlen($Z)>$fB)?substr($Z,$fB):'';}return$EC?rtrim($E,'/'):$E;}function getURLJoin(){if($this->url_type===self::URL_TYPE_QUERY&&!empty($_GET)){$RB=urldecode(http_build_query($_GET));return"?$RB&";}else{return'?';}}function getRelPrefix($E=false){if($E===false){if($this->url_type===self::URL_TYPE_QUERY){return'.';}$E=$this->getCurrURL(false);$WB=substr_count($E,'/')+$this->offset;}else{$WB=substr_count($E,'/');}return($WB>0)?rtrim(str_repeat('../',$WB),'/'):'.';}function getDocsDir(){if(is_null($this->docs_dir)){$bB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($DC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($DC,DOCX_Directory::ATTR_FILE_MTIME,true);}$_=$this->docs_dir->addCache($bB)->getDiffs();$this->updateMetas($_['addfiles']);$this->updateMetas($_['modfiles']);}return$this->docs_dir;}function updateMetas($_){foreach($_ as$B=>$F){foreach($F as$G){$A=&$this->docs_dir->files[$B][$G];$A['slug']=$G;$A['url']=ltrim($B,'.').'/'.$G;$x=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$x->getMetaData());}}}function getMetadata($y){if($y===self::ADMIN_URLPRE){$y=self::HOME_PAGE_URL;}$B='.'.rtrim(dirname($y),'/');$G=basename($y);$U=$this->getDocsDir();if(isset($U->files[$B])&&isset($U->files[$B][$G])){return$U->files[$B][$G];}}function dispatch(){$E=$this->getCurrURL(true);$V=false;if(empty($E)||in_array($E,array('/',self::HOME_PAGE_URL))){$E=self::HOME_PAGE_URL;}else if($E===self::ADMIN_URLPRE){$E=self::HOME_PAGE_URL;$V=true;}else if(starts_with($E,self::ADMIN_URLPRE.'/')){$E=substr($E,strlen(self::ADMIN_URLPRE));$V=true;}$A=$this->getMetadata($E);if(is_null($A)){die($E);}$o=new DOCX_View($this,$A,'',$V);return$o;}function run(){$YB=isset($_GET['action'])?$_GET['action']:false;if($YB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($YB==='staticize'){$this->genPages();return$this->gotoStaticIfCould();}else if($YB==='genpdf'){$w=$this->genPDF();return$w->send($this->getOption('title').'.pdf',true);}$this->dispatch()->output();}function gotoStaticIfCould(){$B=dirname($this->getAbsPrefix());if(starts_with($this->public_dir,APP_ROOT)){if($h=substr($this->public_dir,strlen(APP_ROOT))){$B.=$h;}$Q=$this->getOption('urlext_html');return http_redirect($B.'/index'.$Q);}}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$U=$this->getDocsDir();foreach($U->files as$B=>&$F){foreach($F as$G=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($W=false){if($W===false){$W=$this->public_dir;}$Q=$this->getOption('urlext_html');$f=array('.',$this->index);if(starts_with($this->document_dir,$this->public_dir)){$f[]=trim(substr($this->document_dir,strlen($this->public_dir)),'/');}DOCX_Directory::removeAll($this->public_dir,$f);$U=$this->getDocsDir();foreach($U->files as$B=>&$F){foreach($F as$G=>&$A){$e=$W.$A['url'].$Q;$o=new DOCX_View($this,$A,'',false);$o->staticize($e);}}}function genPDF(){$w=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$this->assets_dir.'/css/style.min.css','run-script'=>array($this->assets_dir.'/js/jquery.min.js',$this->assets_dir.'/js/highlight.min.js',$this->assets_dir.'/js/pdfscript.js',),));$XB=$this->getDocsDir();foreach($XB->files as$B=>&$F){foreach($F as$G=>&$A){if(self::isHome($A['slug'])){}else{$o=new DOCX_View($this,$A,'pdf.php',false);if($J=$o->getStaticContent()){$w->addPage($J);}}}}return$w;}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($I,&$k=null,&$cB=null){$this->setPath($I);$this->reader=$k;$this->writer=$cB;register_shutdown_function(function($dC){$dC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($I){$this->path=$I;return$this;}function connect(&$eB,$P=null){if(empty($P)){$this->data=&$eB;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$P]=&$eB;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$k=$this->getReader();$this->writer=&$k;}return$this->writer;}function load(&$kB=null){if($k=$this->getReader()){$C=$k->read($this->path);if(!is_null($C)){$this->data=$C;}if(!is_null($kB)){$this->changed=&$kB;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($cB=$this->getWriter()){$cB->write($this->path,$this->data);}return$this->data;}function offsetGet($CB){if(isset($this->data[$CB])){return$this->data[$CB];}}function offsetSet($CB,&$ZB){$this->data[$CB]=$ZB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($I='.',$AB=false,$S=self::ATTR_FILE_MTIME){$I=realpath($I);if(is_dir($I)){$this->dir=$I;$this->extname=$AB;}$this->attr_cmp=$S;}static function removeEmpty($B,$dB=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($B)){return 0;}$i=0;if($dB>=1||$dB>=mt_rand(1,10000)/10000){$F=scandir($B);if(is_array($F)&&count($F)===2){if($F[0]==='.'&&$F[1]==='..'){@rmdir($B);$i++;}}}return$i;}static function removeAll($B,array$f=array()){if(!file_exists($B)){return 0;}$i=0;$SC=scandir($B);foreach($SC as$R){if($f&&in_array($R,$f)){continue;}$SB=rtrim($B,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$R;if(is_dir($SB)){if($R==='.'||$R==='..'){continue;}self::removeAll($SB);}else{unlink($SB);$i++;}}if(!in_array('.',$f)){rmdir($B);}return$i;}static function eraseOrd($L,$VB='_',$q=false){$L=$q?basename($L,$q):basename($L);$K=explode($VB,$L,2);if(count($K)===2&&is_numeric($K[0])){return$K[1];}return$L;}static function getAttrFunc($S){switch($S){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$F,$S,$aB=false){if(in_array($S,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$pB='return $a["'.$S.'"] - $b["'.$S.'"];';}else{$pB='return strcasecmp($a["'.$S.'"], $b["'.$S.'"]);';}$TC=$aB?'$b, $a':'$a, $b';uasort($F,create_function($TC,$pB));}function sortSubDir($h){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$UC=ltrim($h,'.');foreach($this->order_prefixes as$d){if(starts_with($UC,$d)){self::sortFiles($this->files[$h],$this->order_attr,$this->order_desc);}}}function setSorting(array$xB,$rB,$aB=false){if($xB&&$rB===$this->attr_cmp){$this->order_prefixes=$xB;$this->order_attr=$rB;$this->order_desc=$aB;}return$this;}function addCache($bB){$c=new DOCX_Cache($bB);$c->connect($this->files)->load($this->changed);return$this;}function scan(array&$F,$I,$d='.'){$sB=scandir($I);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($sB);}foreach($sB as$p){if(substr($p,0,1)==='.'){continue;}$R=$I.DIRECTORY_SEPARATOR.$p;$AB='.'.pathinfo($p,PATHINFO_EXTENSION);$wB=self::eraseOrd($p,'_',$this->extname?$this->extname:$AB);if(is_dir($R)){$uB=$d.'/'.$wB;$F[$uB]=array();$this->scan($F,$R,$uB);}else if($this->extname===false||$this->extname===$AB){$VC=self::getAttrFunc($this->attr_cmp);$F[$d][$wB]=array('fname'=>$R,$this->attr_cmp=>$VC($R),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$h){$this->sortSubDir($h);}}}return$this->files;}function getDiffs(){$TB=array();$this->scan($TB,$this->dir);$M=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$M['deldirs']=array_diff(array_keys($this->files),array_keys($TB));if(!empty($M['deldirs'])){foreach($M['deldirs']as$B){unset($this->files[$B]);}$this->changed=true;}foreach($TB as$B=>&$F){$GB=isset($this->files[$B])?$this->files[$B]:array();if($FB=array_diff(array_keys($GB),array_keys($F))){$M['delfiles'][$B]=$FB;if(!empty($FB)){foreach($FB as$G){unset($this->files[$B][$G]);}$this->changed=true;}}$PB=array();$IB=array();foreach($F as$G=>&$EB){if(!isset($GB[$G])){$PB[]=$G;$this->files[$B][$G]=&$EB;}else if($EB[$this->attr_cmp]!==$GB[$G][$this->attr_cmp]){$IB[]=$G;$this->files[$B][$G]=&$EB;}}if(!empty($PB)){$M['addfiles'][$B]=$PB;$this->changed=true;}if(!empty($IB)){$M['modfiles'][$B]=$IB;$this->changed=true;}$this->sortSubDir($B);}return$M;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($D,$WC=false){assert(is_string($D));if($WC&&!is_file($D)){try{@mkdir(dirname($D),CACHE_DIR_MODE,true);@touch($D);@chmod($D,CACHE_FILE_MODE);}catch(\Exception$mC){return false;}}if($this->extname===false){$this->extname=pathinfo($D,PATHINFO_EXTENSION);}return$D;}function read($D,$XC=null){$C=null;if($D=$this->prepare($D,true)){$oB='_read'.$this->extname;if(method_exists($this,$oB)){$C=$this->$oB($D);}else{$C=$this->_read($D);}}return(is_null($C)||$C===false)?$XC:$C;}function write($D,&$C,$YC=0){if($D=$this->prepare($D,true)){$yB='_write'.$this->extname;if(method_exists($this,$yB)){return$this->$yB($D,$C);}else{return$this->_write($D,$C);}}}function delete($D){if($D=$this->prepare($D,false)){unlink($D);DOCX_Directory::unlinkEmpty(dirname($D));}}protected function _read($D){if($C=file_get_contents($D)){$qB='_unformat'.$this->extname;if(method_exists($this,$qB)){return$this->$qB($C);}else{return$C;}}}protected function _write($D,&$C,$YC=0){$n='_format'.$this->extname;if(method_exists($this,$n)){$J=$this->$n($C);}else{$J=$C;}return file_put_contents($D,$J,LOCK_EX);}protected function _readPHP($D){if(filesize($D)>0){return(include$D);}}protected function _formatPHP(&$C){return"<?php \nreturn ".var_export($C,true).";\n";}protected function _readCSV($D){$C=array();if(($N=fopen($D,'rb'))!==false){while(($MB=fgetcsv($N,0,$this->csv_delimiter))!==false){$C[]=$MB;}fclose($N);}return$C;}protected function _writeCSV($D,&$C){$zB=0;if(($N=fopen($D,'wb'))!==false){foreach($C as$MB){$zB+=fputcsv($N,$MB,$this->csv_delimiter);}fclose($N);}return$zB;}protected function _formatJSON(&$C){return json_encode($C);}protected function _unformatJSON(&$C){return json_decode($C,true);}protected function _formatYAML(&$C){if(extension_loaded('yaml')){return yaml_emit($C,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$PC=new Yaml\Dumper();return$PC->dump($C);}}protected function _unformatYAML(&$C){if(extension_loaded('yaml')){return yaml_parse($C);}else if(class_exists('Yaml\\Parser',true)){$QC=new Yaml\Parser();return$QC->parse($C);}}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$htmldoc='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($b){$this->filename=$b;}static function getInstance($b){if(!isset(self::$instances[$b])){self::$instances[$b]=new self($b);}return self::$instances[$b];}static function parseMetaLine($H){$K=explode(':',$H);if(count($K)===2){$K[0]=strtolower(trim($K[0]));if(in_array($K[0],self::$meta_keys,true)){$K[1]=trim($K[1]);return$K;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($RC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->htmldoc='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$N=fopen($this->filename,'rb');if($N===false){return false;}$H=fgets($N);$H=$H?trim($H):'';$H=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$H);while(!$H||!trim($H));$KB=0;while($t=strlen($H)){$this->metatext.=$H."\n";if($t>=3&&$H===str_repeat('-',$t)){if($KB<=0){$KB=$t;}else if($KB===$t){$H='';break;}}else if($mB=self::parseMetaLine($H)){$A[$mB[0]]=$mB[1];}else{break;}$H=fgets($N);$H=$H?trim($H):'';}if($RC){$this->markdown=$H.fread($N,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$H;$this->headsize=ftell($N);}fclose($N);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($JB=false){if($this->headsize<0){$this->parseMetaData(false);}if($JB===false){return$this->metadata;}else if(isset($this->metadata[$JB])){return$this->metadata[$JB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$J=file_get_contents($this->filename);$this->markdown=substr($J,$this->headsize);$this->headsize=0;}if(!$this->htmldoc&&$this->markdown){$this->htmldoc=Parsedown::instance()->text($this->markdown);}$ZC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'htmldoc'=>$this->htmldoc,);return array_merge($this->metadata,$ZC);}function update($aC,$hC){$J=$aC."\n\n".$hC;file_put_contents($this->filename,$J,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($s,$iC=''){if($s){$this->setSourceDir($s);}$this->cache_dir=rtrim($iC,' /\\');}static function replaceWith($J,array$a=array(),$d='',$jC=''){if(!empty($a)){$lB=array();$jB=array();foreach($a as$P=>&$ZB){$lB[]=$d.$P.$jC;$jB[]=$ZB;}$J=str_replace($lB,$jB,$J);}return$J;}function setSourceDir($s){$this->source_dir=rtrim($s,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($v,&$J){if(!isset($this->caches[$v])){$c=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$v);$this->caches[$v]=&$c;}else{$c=&$this->caches[$v];}$c->connect($J)->load();return$c;}function updateGlobals(array$OC){$this->globals=array_merge($this->globals,$OC);}function prepareFile($Y){return$this->source_dir.'/'.$Y;}function render($Y,array$a=array(),$hB=false){$this->current_file=$Y;if($hB){ob_start();}extract($this->globals);extract($a);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$kC=array_pop($this->extend_files);foreach($this->extend_files as$G){include$this->prepareFile($G);}extract($this->template_blocks);include$this->prepareFile($kC);}if($hB){$M=ob_get_clean();return$M?trim($M):'';}}function extendTpl($Y){array_push($this->extend_files,$Y);}function includeTpl($Y,array$a=array(),$gC=false){extract($this->globals);extract($a);include$this->prepareFile($Y);}function blockStart($fC='content',$gC=false){$this->current_block=$fC;ob_start();}function blockEnd(){$bC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$bC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($cC,array&$A,$O='',$V=false){$this->app=$cC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($O,$V);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($O,$V=false){if(empty($O)){if(isset($this->metadata['layout'])){$O=$this->metadata['layout'];}if(empty($O)){$O=$this->app->getOption('layout');}$O=($V?'edit/':'').$O.'.php';}return is_readable($this->app->theme_dir.'/'.$O)?$O:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($l=false){if($l===false){$l=$this->app->public_dir;}$W=$l.'/assets';if(!file_exists($W)){$eC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';if(realpath($W)!==$this->app->assets_dir){@shell_exec($eC.' '.$this->app->assets_dir.' '.$W);}}}function getTemplater(){if(is_null($this->templater)){$XB=$this->app->getDocsDir();$this->templater=new DOCX_Templater($this->app->theme_dir,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'url_join'=>$this->app->getURLJoin(),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$XB->files,);$this->ensureAssets($this->app->public_dir);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$x=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$x->update($_POST['metatext'],trim($_POST['markdown']));}$gB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$gB=$this->app->getToppestPage();}$z=$this->getTemplater();$z->globals['urlpre']=self::URL_PRE;$z->globals['urlext']=self::URL_EXT;$z->globals['assets_url']=self::URL_ASSETS;$this->content=$z->render($this->tpl_file,array('view'=>&$this,'page'=>$x->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$gB,),true);}function output(){$this->renderPage();$Q=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$Q;$this->replacers[self::HTML_HIDE]='{}';$DB=$this->app->getRelPrefix();$lC=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$DB.'/assets';$J=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($J);}function getStaticContent(){$this->renderPage();$Q=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$Q;$this->replacers[self::HTML_HIDE]='{display: none}';$E=$this->metadata['url'].$Q;$DB=$this->app->getRelPrefix(ltrim($E,'/'));$this->replacers[self::URL_PRE]=$DB;$this->replacers[self::URL_ASSETS]=$DB.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($e=false){$l=$this->app->public_dir;if($e===false){$e=$l.$this->metadata['url'].$Q;}@mkdir(dirname($e),0755,true);$J=$this->getStaticContent();return file_put_contents($e,$J,LOCK_EX);}}defined('APP_ROOT')or die('Illeigal access');function autoload_class($BB){if(substr($BB,0,5)==='DOCX_'){$I='DocX/'.substr($BB,5).'.php';}else{$I=$BB.'.php';}require_once DOCX_ROOT.'/library/'.$I;return class_exists($BB,false);}function starts_with($u,$j){return strncmp($u,$j,strlen($j))===0;}function ends_with($u,$j){$LB=strlen($j);return$LB===0||(strlen($u)>=$LB&&substr_compare($u,$j,-$LB)===0);}function convert($r,$g='UTF-8'){$g=strtoupper($g);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($r,$g,true)?$r:mb_convert_encoding($r,$g,'UTF-8, GBK');}else if(function_exists('iconv')){$LC=$g==='UTF-8'?'GBK':'UTF-8';return iconv($LC,$g.'//IGNORE',$r);}}function http_redirect($MC='',$NC=false){$JC=$NC?301:302;@header('Location: '.$MC,true,$JC);return die();}function compare_pathes($T,$X){if($T===$X){return array($T,0,0);}else if(starts_with($T,$X)){$FC=substr_count(substr($T,strlen($X)),'/');return array($X,0,$FC);}else if(starts_with($X,$T)){$CC=substr_count(substr($X,strlen($T)),'/');return array($T,$CC,0);}$iB=explode('/',$X);$NB=explode('/',$T);$_B=count($iB);foreach($NB as$m=>$IC){if($m>=$_B||$IC!==$iB[$m]){$HC=implode('/',array_slice($NB,0,$m));return array($HC,$_B-$m,count($NB)-$m);}}return array('',-1,-1);}function clean_ord($L,$q='.md',$VB='_'){$L=basename($L,$q);$K=explode($VB,$L,2);if(count($K)===2&&is_numeric($K[0])){return$K[1];}return$L;}function slugify($L){return strtolower(str_replace(' ','-',$L));}function rand_greeting($OB){static$HB=0;if($HB===0){shuffle($OB);$HB=count($OB);}return$OB[--$HB];}function zh_date($n,$BC=false){$M=date($n,$BC);if(strpos($n,'星期w')!==false){$tB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$M=str_replace(array_keys($tB),array_values($tB),$M);}return$M;}