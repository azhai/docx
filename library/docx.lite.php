<?php
class DOCX_App{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$document_dir='';var$public_dir='';var$cache_dir='';var$theme_dir='';var$assets_dir='';protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$offset=0;protected$index='index.php';protected$route='r';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>self::URL_TYPE_AUTO,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($wB=false){if(is_array($wB)){$this->options=array_merge($this->options,$wB);}$this->document_dir=self::getRealPath($this->getOption('document_dir'));$this->public_dir=self::getRealPath($this->getOption('public_dir'));$this->cache_dir=self::getRealPath($this->getOption('cache_dir'));$this->theme_dir=self::getRealPath($this->getOption('theme_dir'));$this->assets_dir=self::getRealPath($this->getOption('assets_dir'));$this->abs_prefix=$this->getAbsPrefix();}static function getRealPath($D){$I=APP_ROOT.DIRECTORY_SEPARATOR.trim($D,'/');$ZB=realpath($I);if($ZB===false){@mkdir($I,0755,true);$ZB=realpath($I);}return$ZB;}static function isHome($JC){return$JC==='home';}static function getRawURL(){$a=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($a)?'/':urldecode($a);}function getConstant($L){return constant(__CLASS__.'::'.$L);}function getOption($O=false){if($O===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$O])){return$_ENV[$O];}else if(isset($this->options[$O])){return$this->options[$O];}}function getAbsPrefix(){if($this->abs_prefix!==false){return$this->abs_prefix;}$this->url_type=intval($this->getOption('url_type'));$this->abs_prefix=rtrim($this->getOption('url_prefix'),'/');$MC=array(self::URL_TYPE_QUERY,self::URL_TYPE_TAIL,self::URL_TYPE_REWRITE);if(!in_array($this->url_type,$MC)){$this->url_type=$this->fixURLType();}return$this->abs_prefix;}function fixURLType(){$bB='!([a-zA-Z0-9_-]+\.php)!';if(preg_match($bB,$this->abs_prefix,$cB,PREG_OFFSET_CAPTURE)){list($this->index,$PC)=$cB[0];$bB='!^\?([a-zA-Z0-9_-]+)=!';$aB=substr($this->abs_prefix,$PC+strlen($this->index));if(preg_match($bB,$aB,$cB)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$cB[1];}else{$this->url_type=self::URL_TYPE_TAIL;}$this->abs_prefix=rtrim($this->abs_prefix,'?&');}else{$this->url_type=self::URL_TYPE_REWRITE;$this->abs_prefix=rtrim($this->abs_prefix,'/');}return$this->url_type;}function getCurrURL($CC=false){$a=self::getRawURL();if($this->url_type===self::URL_TYPE_QUERY){$E='';if(isset($_GET[$this->route])){$E='/'.trim($_GET[$this->route],'/').'/';}$this->offset=-99;}else{if($this->url_type===self::URL_TYPE_REWRITE){$a=str_replace('/'.$this->index,'/',$a);$this->offset=-1;}$mB=strlen($this->getAbsPrefix());$E=(strlen($a)>$mB)?substr($a,$mB):'';}return$CC?rtrim($E,'/'):$E;}function getURLJoin(){if($this->url_type===self::URL_TYPE_QUERY&&!empty($_GET)){$aB=urldecode(http_build_query($_GET));return"?$aB&";}else{return'?';}}function getRelPrefix($E=false){if($E===false){if($this->url_type===self::URL_TYPE_QUERY){return'.';}$E=$this->getCurrURL(false);$SB=substr_count($E,'/')+$this->offset;}else{$SB=substr_count($E,'/');}return($SB>0)?rtrim(str_repeat('../',$SB),'/'):'.';}function getDocsDir(){if(is_null($this->docs_dir)){$RB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($gC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($gC,DOCX_Directory::ATTR_FILE_MTIME,true);}$x=$this->docs_dir->addCache($RB)->getDiffs();$this->updateMetas($x['addfiles']);$this->updateMetas($x['modfiles']);}return$this->docs_dir;}function updateMetas($x){foreach($x as$D=>$F){foreach($F as$G){$A=&$this->docs_dir->files[$D][$G];$A['slug']=$G;$A['url']=ltrim($D,'.').'/'.$G;$q=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$q->getMetaData());}}}function getMetadata($v){if($v===self::ADMIN_URLPRE){$v=self::HOME_PAGE_URL;}$D='.'.rtrim(dirname($v),'/');$G=basename($v);$X=$this->getDocsDir();if(isset($X->files[$D])&&isset($X->files[$D][$G])){return$X->files[$D][$G];}}function dispatch(){$E=$this->getCurrURL(true);$V=false;if(empty($E)||in_array($E,array('/',self::HOME_PAGE_URL))){$E=self::HOME_PAGE_URL;}else if($E===self::ADMIN_URLPRE){$E=self::HOME_PAGE_URL;$V=true;}else if(starts_with($E,self::ADMIN_URLPRE.'/')){$E=substr($E,strlen(self::ADMIN_URLPRE));$V=true;}$A=$this->getMetadata($E);if(is_null($A)){die($E);}$j=new DOCX_View($this,$A,'',$V);return$j;}function run(){$QB=isset($_GET['action'])?$_GET['action']:false;if($QB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($QB==='staticize'){$this->genPages();return http_redirect($this->getStaticIndex());}else if($QB==='genpdf'){$r=$this->genPDF();return$r->send($this->getOption('title').'.pdf',true);}$this->dispatch()->output();}function getStaticIndex(){$h=$this->getRelPrefix();$U=trim($this->getOption('public_dir'),' /');$Q=$this->getOption('urlext_html');return$h.'/'.$U.'/index'.$Q;}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$X=$this->getDocsDir();foreach($X->files as$D=>&$F){foreach($F as$G=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($Y=false){if($Y===false){$Y=$this->public_dir;}$Q=$this->getOption('urlext_html');DOCX_Directory::removeAll($this->public_dir,array('.',$this->index));$X=$this->getDocsDir();foreach($X->files as$D=>&$F){foreach($F as$G=>&$A){$e=$Y.$A['url'].$Q;$j=new DOCX_View($this,$A,'',false);$j->staticize($e);}}}function genPDF(){$r=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$this->assets_dir.'/css/style.min.css','run-script'=>array($this->assets_dir.'/js/jquery.min.js',$this->assets_dir.'/js/highlight.min.js',$this->assets_dir.'/js/pdfscript.js',),));$UB=$this->getDocsDir();foreach($UB->files as$D=>&$F){foreach($F as$G=>&$A){if(self::isHome($A['slug'])){}else{$j=new DOCX_View($this,$A,'pdf.php',false);if($J=$j->getStaticContent()){$r->addPage($J);}}}}return$r;}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($I,&$m=null,&$WB=null){$this->setPath($I);$this->reader=$m;$this->writer=$WB;register_shutdown_function(function($UC){$UC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($I){$this->path=$I;return$this;}function connect(&$eB,$O=null){if(empty($O)){$this->data=&$eB;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$O]=&$eB;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$m=$this->getReader();$this->writer=&$m;}return$this->writer;}function load(&$hB=null){if($m=$this->getReader()){$B=$m->read($this->path);if(!is_null($B)){$this->data=$B;}if(!is_null($hB)){$this->changed=&$hB;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($WB=$this->getWriter()){$WB->write($this->path,$this->data);}return$this->data;}function offsetGet($CB){if(isset($this->data[$CB])){return$this->data[$CB];}}function offsetSet($CB,&$YB){$this->data[$CB]=$YB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($I='.',$z=false,$S=self::ATTR_FILE_MTIME){$I=realpath($I);if(is_dir($I)){$this->dir=$I;$this->extname=$z;}$this->attr_cmp=$S;}static function removeEmpty($D,$fB=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($D)){return 0;}$i=0;if($fB>=1||$fB>=mt_rand(1,10000)/10000){$F=scandir($D);if(is_array($F)&&count($F)===2){if($F[0]==='.'&&$F[1]==='..'){@rmdir($D);$i++;}}}return$i;}static function removeAll($D,array$TB=array()){if(!file_exists($D)){return 0;}$i=0;$XC=scandir($D);foreach($XC as$R){if($TB&&in_array($R,$TB)){continue;}$dB=rtrim($D,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$R;if(is_dir($dB)){if($R==='.'||$R==='..'){continue;}self::removeAll($dB);}else{unlink($dB);$i++;}}if(!in_array('.',$TB)){rmdir($D);}return$i;}static function eraseOrd($L,$XB='_',$u=false){$L=$u?basename($L,$u):basename($L);$K=explode($XB,$L,2);if(count($K)===2&&is_numeric($K[0])){return$K[1];}return$L;}static function getAttrFunc($S){switch($S){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$F,$S,$VB=false){if(in_array($S,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$rB='return $a["'.$S.'"] - $b["'.$S.'"];';}else{$rB='return strcasecmp($a["'.$S.'"], $b["'.$S.'"]);';}$AC=$VB?'$b, $a':'$a, $b';uasort($F,create_function($AC,$rB));}function sortSubDir($o){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$EC=ltrim($o,'.');foreach($this->order_prefixes as$f){if(starts_with($EC,$f)){self::sortFiles($this->files[$o],$this->order_attr,$this->order_desc);}}}function setSorting(array$uB,$sB,$VB=false){if($uB&&$sB===$this->attr_cmp){$this->order_prefixes=$uB;$this->order_attr=$sB;$this->order_desc=$VB;}return$this;}function addCache($RB){$c=new DOCX_Cache($RB);$c->connect($this->files)->load($this->changed);return$this;}function scan(array&$F,$I,$f='.'){$qB=scandir($I);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($qB);}foreach($qB as$BB){if(substr($BB,0,1)==='.'){continue;}$R=$I.DIRECTORY_SEPARATOR.$BB;$z='.'.pathinfo($BB,PATHINFO_EXTENSION);$yB=self::eraseOrd($BB,'_',$this->extname?$this->extname:$z);if(is_dir($R)){$_B=$f.'/'.$yB;$F[$_B]=array();$this->scan($F,$R,$_B);}else if($this->extname===false||$this->extname===$z){$TC=self::getAttrFunc($this->attr_cmp);$F[$f][$yB]=array('fname'=>$R,$this->attr_cmp=>$TC($R),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$o){$this->sortSubDir($o);}}}return$this->files;}function getDiffs(){$HB=array();$this->scan($HB,$this->dir);$M=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$M['deldirs']=array_diff(array_keys($this->files),array_keys($HB));if(!empty($M['deldirs'])){foreach($M['deldirs']as$D){unset($this->files[$D]);}$this->changed=true;}foreach($HB as$D=>&$F){$PB=isset($this->files[$D])?$this->files[$D]:array();if($FB=array_diff(array_keys($PB),array_keys($F))){$M['delfiles'][$D]=$FB;if(!empty($FB)){foreach($FB as$G){unset($this->files[$D][$G]);}$this->changed=true;}}$EB=array();$DB=array();foreach($F as$G=>&$OB){if(!isset($PB[$G])){$EB[]=$G;$this->files[$D][$G]=&$OB;}else if($OB[$this->attr_cmp]!==$PB[$G][$this->attr_cmp]){$DB[]=$G;$this->files[$D][$G]=&$OB;}}if(!empty($EB)){$M['addfiles'][$D]=$EB;$this->changed=true;}if(!empty($DB)){$M['modfiles'][$D]=$DB;$this->changed=true;}$this->sortSubDir($D);}return$M;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($C,$OC=false){assert(is_string($C));if($OC&&!is_file($C)){try{@mkdir(dirname($C),CACHE_DIR_MODE,true);@touch($C);@chmod($C,CACHE_FILE_MODE);}catch(\Exception$mC){return false;}}if($this->extname===false){$this->extname=pathinfo($C,PATHINFO_EXTENSION);}return$C;}function read($C,$QC=null){$B=null;if($C=$this->prepare($C,true)){$zB='_read'.$this->extname;if(method_exists($this,$zB)){$B=$this->$zB($C);}else{$B=$this->_read($C);}}return(is_null($B)||$B===false)?$QC:$B;}function write($C,&$B,$hC=0){if($C=$this->prepare($C,true)){$vB='_write'.$this->extname;if(method_exists($this,$vB)){return$this->$vB($C,$B);}else{return$this->_write($C,$B);}}}function delete($C){if($C=$this->prepare($C,false)){unlink($C);DOCX_Directory::unlinkEmpty(dirname($C));}}protected function _read($C){if($B=file_get_contents($C)){$tB='_unformat'.$this->extname;if(method_exists($this,$tB)){return$this->$tB($B);}else{return$B;}}}protected function _write($C,&$B,$hC=0){$k='_format'.$this->extname;if(method_exists($this,$k)){$J=$this->$k($B);}else{$J=$B;}return file_put_contents($C,$J,LOCK_EX);}protected function _readPHP($C){if(filesize($C)>0){return(include$C);}}protected function _formatPHP(&$B){return"<?php \nreturn ".var_export($B,true).";\n";}protected function _readCSV($C){$B=array();if(($N=fopen($C,'rb'))!==false){while(($NB=fgetcsv($N,0,$this->csv_delimiter))!==false){$B[]=$NB;}fclose($N);}return$B;}protected function _writeCSV($C,&$B){$xB=0;if(($N=fopen($C,'wb'))!==false){foreach($B as$NB){$xB+=fputcsv($N,$NB,$this->csv_delimiter);}fclose($N);}return$xB;}protected function _formatJSON(&$B){return json_encode($B);}protected function _unformatJSON(&$B){return json_decode($B,true);}protected function _formatYAML(&$B){if(extension_loaded('yaml')){return yaml_emit($B,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$VC=new Yaml\Dumper();return$VC->dump($B);}}protected function _unformatYAML(&$B){if(extension_loaded('yaml')){return yaml_parse($B);}else if(class_exists('Yaml\\Parser',true)){$YC=new Yaml\Parser();return$YC->parse($B);}}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$dochtml='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($d){$this->filename=$d;}static function getInstance($d){if(!isset(self::$instances[$d])){self::$instances[$d]=new self($d);}return self::$instances[$d];}static function parseMetaLine($H){$K=explode(':',$H);if(count($K)===2){$K[0]=strtolower(trim($K[0]));if(in_array($K[0],self::$meta_keys,true)){$K[1]=trim($K[1]);return$K;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($eC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->dochtml='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$N=fopen($this->filename,'rb');if($N===false){return false;}$H=fgets($N);$H=$H?trim($H):'';$H=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$H);while(!$H||!trim($H));$KB=0;while($t=strlen($H)){$this->metatext.=$H."\n";if($t>=3&&$H===str_repeat('-',$t)){if($KB<=0){$KB=$t;}else if($KB===$t){$H='';break;}}else if($gB=self::parseMetaLine($H)){$A[$gB[0]]=$gB[1];}else{break;}$H=fgets($N);$H=$H?trim($H):'';}if($eC){$this->markdown=$H.fread($N,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$H;$this->headsize=ftell($N);}fclose($N);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($IB=false){if($this->headsize<0){$this->parseMetaData(false);}if($IB===false){return$this->metadata;}else if(isset($this->metadata[$IB])){return$this->metadata[$IB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$J=file_get_contents($this->filename);$this->markdown=substr($J,$this->headsize);$this->headsize=0;}if(!$this->dochtml&&$this->markdown){$this->dochtml=Parsedown::instance()->text($this->markdown);}$ZC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'dochtml'=>$this->dochtml,);return array_merge($this->metadata,$ZC);}function update($aC,$WC){$J=$aC."\n\n".$WC;file_put_contents($this->filename,$J,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($w,$RC=''){if($w){$this->setSourceDir($w);}$this->cache_dir=rtrim($RC,' /\\');}static function replaceWith($J,array$b=array(),$f='',$SC=''){if(!empty($b)){$oB=array();$pB=array();foreach($b as$O=>&$YB){$oB[]=$f.$O.$SC;$pB[]=$YB;}$J=str_replace($oB,$pB,$J);}return$J;}function setSourceDir($w){$this->source_dir=rtrim($w,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($y,&$J){if(!isset($this->caches[$y])){$c=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$y);$this->caches[$y]=&$c;}else{$c=&$this->caches[$y];}$c->connect($J)->load();return$c;}function updateGlobals(array$bC){$this->globals=array_merge($this->globals,$bC);}function prepareFile($W){return$this->source_dir.'/'.$W;}function render($W,array$b=array(),$nB=false){$this->current_file=$W;if($nB){ob_start();}extract($this->globals);extract($b);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$cC=array_pop($this->extend_files);foreach($this->extend_files as$G){include$this->prepareFile($G);}extract($this->template_blocks);include$this->prepareFile($cC);}if($nB){$M=ob_get_clean();return$M?trim($M):'';}}function extendTpl($W){array_push($this->extend_files,$W);}function includeTpl($W,array$b=array(),$jC=false){extract($this->globals);extract($b);include$this->prepareFile($W);}function blockStart($kC='content',$jC=false){$this->current_block=$kC;ob_start();}function blockEnd(){$lC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$lC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($iC,array&$A,$P='',$V=false){$this->app=$iC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($P,$V);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($P,$V=false){if(empty($P)){if(isset($this->metadata['layout'])){$P=$this->metadata['layout'];}if(empty($P)){$P=$this->app->getOption('layout');}$P=($V?'edit/':'').$P.'.php';}return is_readable($this->app->theme_dir.'/'.$P)?$P:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($U=false){if($U===false){$U=$this->app->public_dir;}$Y=$U.'/assets';if(!file_exists($Y)){$dC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';if(realpath($Y)!==$this->app->assets_dir){@shell_exec($dC.' '.$this->app->assets_dir.' '.$Y);}}}function getTemplater(){if(is_null($this->templater)){$UB=$this->app->getDocsDir();$this->templater=new DOCX_Templater($this->app->theme_dir,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'url_join'=>$this->app->getURLJoin(),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$UB->files,);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$q=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$q->update($_POST['metatext'],trim($_POST['markdown']));}$iB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$iB=$this->app->getToppestPage();}$s=$this->getTemplater();$s->globals['urlpre']=self::URL_PRE;$s->globals['urlext']=self::URL_EXT;$s->globals['assets_url']=self::URL_ASSETS;$this->content=$s->render($this->tpl_file,array('view'=>&$this,'page'=>$q->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$iB,),true);}function output(){$this->renderPage();$Q=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$Q;$this->replacers[self::HTML_HIDE]='{}';$h=$this->app->getRelPrefix();$fC=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$h.'/'.$fC;$J=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($J);}function getStaticContent(){$this->renderPage();$Q=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$Q;$this->replacers[self::HTML_HIDE]='{display: none}';$E=$this->metadata['url'].$Q;$h=$this->app->getRelPrefix(ltrim($E,'/'));$this->replacers[self::URL_PRE]=$h;$this->replacers[self::URL_ASSETS]=$h.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($e=false){$U=$this->app->public_dir;$this->ensureAssets($U);if($e===false){$e=$U.$this->metadata['url'].$Q;}@mkdir(dirname($e),0755,true);$J=$this->getStaticContent();return file_put_contents($e,$J,LOCK_EX);}}defined('APP_ROOT')or die('Illeigal access');function autoload_class($p){if(substr($p,0,5)==='DOCX_'){$I='DocX/'.substr($p,5).'.php';}else{$I=$p.'.php';}require_once APP_ROOT.'/library/'.$I;return class_exists($p,false);}function starts_with($AB,$n){return strncmp($AB,$n,strlen($n))===0;}function ends_with($AB,$n){$JB=strlen($n);return$JB===0||(strlen($AB)>=$JB&&substr_compare($AB,$n,-$JB)===0);}function convert($_,$g='UTF-8'){$g=strtoupper($g);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($_,$g,true)?$_:mb_convert_encoding($_,$g,'UTF-8, GBK');}else if(function_exists('iconv')){$DC=$g==='UTF-8'?'GBK':'UTF-8';return iconv($DC,$g.'//IGNORE',$_);}}function http_redirect($GC='',$BC=false){$FC=$BC?301:302;@header('Location: '.$GC,true,$FC);return die();}function compare_pathes($T,$Z){if($T===$Z){return array($T,0,0);}else if(starts_with($T,$Z)){$NC=substr_count(substr($T,strlen($Z)),'/');return array($Z,0,$NC);}else if(starts_with($Z,$T)){$HC=substr_count(substr($Z,strlen($T)),'/');return array($T,$HC,0);}$lB=explode('/',$Z);$LB=explode('/',$T);$jB=count($lB);foreach($LB as$l=>$LC){if($l>=$jB||$LC!==$lB[$l]){$IC=implode('/',array_slice($LB,0,$l));return array($IC,$jB-$l,count($LB)-$l);}}return array('',-1,-1);}function clean_ord($L,$u='.md',$XB='_'){$L=basename($L,$u);$K=explode($XB,$L,2);if(count($K)===2&&is_numeric($K[0])){return$K[1];}return$L;}function slugify($L){return strtolower(str_replace(' ','-',$L));}function rand_greeting($MB){static$GB=0;if($GB===0){shuffle($MB);$GB=count($MB);}return$MB[--$GB];}function zh_date($k,$KC=false){$M=date($k,$KC);if(strpos($k,'星期w')!==false){$kB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$M=str_replace(array_keys($kB),array_values($kB),$M);}return$M;}