<?php
class DOCX_App{const URL_TYPE_QUERY=0;const URL_TYPE_TAIL=1;const URL_TYPE_REWRITE=2;const URL_TYPE_AUTO=9;const HOME_PAGE_URL='/index';const ADMIN_URLPRE='/admin';var$document_dir='';var$public_dir='';var$cache_dir='';var$theme_dir='';var$assets_dir='';protected$abs_prefix=false;protected$url_type=self::URL_TYPE_AUTO;protected$offset=0;protected$index='index.php';protected$route='r';protected$docs_dir=null;protected$toppest_url='';protected$options=array('url_prefix'=>'/index.php','url_type'=>self::URL_TYPE_AUTO,'title'=>"我的文档",'tagline'=>false,'reading'=>"开始阅读文档",'cover_image'=>'','author'=>'','layout'=>'post','document_dir'=>'documents','public_dir'=>'public','theme_dir'=>'theme','assets_dir'=>'theme/assets','cache_dir'=>'cache','cache_ext'=>'.json','urlext_php'=>'/','urlext_html'=>'.html','timezone'=>'Asia/Shanghai','blog_sorting'=>array(),'date_format'=>'Y年n月j日 星期w','repo'=>false,'links'=>array(),'google_analytics'=>false,'ignore'=>array('folders'=>array('.git',)),'wkhtmltopdf'=>null,'greetings'=>array(),);function __construct($vB=false){if(is_array($vB)){$this->options=array_merge($this->options,$vB);}$this->document_dir=self::getRealPath($this->getOption('document_dir'));$this->public_dir=self::getRealPath($this->getOption('public_dir'));$this->cache_dir=self::getRealPath($this->getOption('cache_dir'));$this->theme_dir=self::getRealPath($this->getOption('theme_dir'));$this->assets_dir=self::getRealPath($this->getOption('assets_dir'));$this->abs_prefix=$this->getAbsPrefix();}static function getRealPath($B){$J=DOCX_ROOT.DIRECTORY_SEPARATOR.trim($B,'/');$RB=realpath($J);if($RB===false){@mkdir($J,0755,true);$RB=realpath($J);}return$RB;}static function isHome($GC){return$GC==='home';}static function getRawURL(){$Y=parse_url($_SERVER['REQUEST_URI'],PHP_URL_PATH);return is_null($Y)?'/':urldecode($Y);}function getConstant($L){return constant(__CLASS__.'::'.$L);}function getOption($P=false){if($P===false){return array_merge($this->options,$_ENV);}else if(isset($_ENV[$P])){return$_ENV[$P];}else if(isset($this->options[$P])){return$this->options[$P];}}function getAbsPrefix(){if($this->abs_prefix!==false){return$this->abs_prefix;}$this->url_type=intval($this->getOption('url_type'));$this->abs_prefix=rtrim($this->getOption('url_prefix'),'/');$HC=array(self::URL_TYPE_QUERY,self::URL_TYPE_TAIL,self::URL_TYPE_REWRITE);if(!in_array($this->url_type,$HC)){$this->url_type=$this->fixURLType();}return$this->abs_prefix;}function fixURLType(){$TB='!([a-zA-Z0-9_-]+\.php)!';if(preg_match($TB,$this->abs_prefix,$UB,PREG_OFFSET_CAPTURE)){list($this->index,$BC)=$UB[0];$TB='!^\?([a-zA-Z0-9_-]+)=!';$QB=substr($this->abs_prefix,$BC+strlen($this->index));if(preg_match($TB,$QB,$UB)){$this->url_type=self::URL_TYPE_QUERY;$this->route=$UB[1];}else{$this->url_type=self::URL_TYPE_TAIL;}$this->abs_prefix=rtrim($this->abs_prefix,'?&');}else{$this->url_type=self::URL_TYPE_REWRITE;$this->abs_prefix=rtrim($this->abs_prefix,'/');}return$this->url_type;}function getCurrURL($FC=false){$Y=self::getRawURL();if($this->url_type===self::URL_TYPE_QUERY){$E='';if(isset($_GET[$this->route])){$E='/'.trim($_GET[$this->route],'/').'/';}$this->offset=-99;}else{if($this->url_type===self::URL_TYPE_REWRITE){$Y=str_replace('/'.$this->index,'/',$Y);$this->offset=-1;}$gB=strlen($this->getAbsPrefix());$E=(strlen($Y)>$gB)?substr($Y,$gB):'';}return$FC?rtrim($E,'/'):$E;}function getURLJoin(){if($this->url_type===self::URL_TYPE_QUERY&&!empty($_GET)){$QB=urldecode(http_build_query($_GET));return"?$QB&";}else{return'?';}}function getRelPrefix($E=false){if($E===false){if($this->url_type===self::URL_TYPE_QUERY){return'.';}$E=$this->getCurrURL(false);$aB=substr_count($E,'/')+$this->offset;}else{$aB=substr_count($E,'/');}return($aB>0)?rtrim(str_repeat('../',$aB),'/'):'.';}function getDocsDir(){if(is_null($this->docs_dir)){$cB=$this->cache_dir.'/docs'.$this->getOption('cache_ext');$this->docs_dir=new DOCX_Directory($this->document_dir,'.md');if($DC=$this->getOption('blog_sorting')){$this->docs_dir->setSorting($DC,DOCX_Directory::ATTR_FILE_MTIME,true);}$z=$this->docs_dir->addCache($cB)->getDiffs();$this->updateMetas($z['addfiles']);$this->updateMetas($z['modfiles']);}return$this->docs_dir;}function updateMetas($z){foreach($z as$B=>$F){foreach($F as$G){$A=&$this->docs_dir->files[$B][$G];$A['slug']=$G;$A['url']=ltrim($B,'.').'/'.$G;$y=DOCX_Markdoc::getInstance($A['fname']);$A=array_merge($A,$y->getMetaData());}}}function getMetadata($q){if($q===self::ADMIN_URLPRE){$q=self::HOME_PAGE_URL;}$B='.'.rtrim(dirname($q),'/');$G=basename($q);$W=$this->getDocsDir();if(isset($W->files[$B])&&isset($W->files[$B][$G])){return$W->files[$B][$G];}}function dispatch(){$E=$this->getCurrURL(true);$V=false;if(empty($E)||in_array($E,array('/',self::HOME_PAGE_URL))){$E=self::HOME_PAGE_URL;}else if($E===self::ADMIN_URLPRE){$E=self::HOME_PAGE_URL;$V=true;}else if(starts_with($E,self::ADMIN_URLPRE.'/')){$E=substr($E,strlen(self::ADMIN_URLPRE));$V=true;}$A=$this->getMetadata($E);if(is_null($A)){die($E);}$m=new DOCX_View($this,$A,'',$V);return$m;}function run(){$ZB=isset($_GET['action'])?$_GET['action']:false;if($ZB==='cleancache'){DOCX_Directory::removeAll($this->cache_dir,array('.'));}else if($ZB==='staticize'){$this->genPages();return$this->gotoStaticIfCould();}else if($ZB==='genpdf'){$v=$this->genPDF();return$v->send($this->getOption('title').'.pdf',true);}$this->dispatch()->output();}function gotoStaticIfCould(){$B=dirname($this->getAbsPrefix());if(starts_with($this->public_dir,APP_ROOT)){$B.=substr($this->public_dir,strlen(APP_ROOT));$R=$this->getOption('urlext_html');return http_redirect($B.'/index'.$R);}}function getToppestPage(){if(!empty($this->toppest_url)){return$this->toppest_url;}$W=$this->getDocsDir();foreach($W->files as$B=>&$F){foreach($F as$G=>&$A){if(!self::isHome($A['slug'])){return$A['url'];}}}}function genPages($Z=false){if($Z===false){$Z=$this->public_dir;}$R=$this->getOption('urlext_html');$a=array('.',$this->index);if(starts_with($this->document_dir,$this->public_dir)){$a[]=trim(substr($this->document_dir,strlen($this->public_dir)),'/');}DOCX_Directory::removeAll($this->public_dir,$a);$W=$this->getDocsDir();foreach($W->files as$B=>&$F){foreach($F as$G=>&$A){$f=$Z.$A['url'].$R;$m=new DOCX_View($this,$A,'',false);$m->staticize($f);}}}function genPDF(){$v=new WkHtmlToPdf(array('binPath'=>$this->getOption('wkhtmltopdf'),'encoding'=>'UTF-8','user-style-sheet'=>$this->assets_dir.'/css/style.min.css','run-script'=>array($this->assets_dir.'/js/jquery.min.js',$this->assets_dir.'/js/highlight.min.js',$this->assets_dir.'/js/pdfscript.js',),));$YB=$this->getDocsDir();foreach($YB->files as$B=>&$F){foreach($F as$G=>&$A){if(self::isHome($A['slug'])){}else{$m=new DOCX_View($this,$A,'pdf.php',false);if($I=$m->getStaticContent()){$v->addPage($I);}}}}return$v;}}class DOCX_Cache{protected$data=null;protected$changed=null;protected$path='';protected$reader=null;protected$writer=null;protected$closed=false;protected$signature='';function __construct($J,&$n=null,&$dB=null){$this->setPath($J);$this->reader=$n;$this->writer=$dB;register_shutdown_function(function($dC){$dC->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){if($this->isChanged()){$this->save();}unset($this->data);}function sign(){if($this->data instanceof DOCX_Array){return;}else{return serialize($this->data);}}function isChanged(){if(!is_null($this->changed)){return$this->changed;}else{return$this->signature!==$this->sign();}}function setPath($J){$this->path=$J;return$this;}function connect(&$iB,$P=null){if(empty($P)){$this->data=&$iB;}else{if(!is_array($this->data)){$this->data=array();}$this->data[$P]=&$iB;}return$this;}protected function getReader(){if(is_null($this->reader)){$this->reader=new DOCX_FileKeeper();}return$this->reader;}protected function getWriter(){if(is_null($this->writer)){$n=$this->getReader();$this->writer=&$n;}return$this->writer;}function load(&$jB=null){if($n=$this->getReader()){$C=$n->read($this->path);if(!is_null($C)){$this->data=$C;}if(!is_null($jB)){$this->changed=&$jB;}else{$this->signature=$this->sign();}}return$this->data;}function save(){if($dB=$this->getWriter()){$dB->write($this->path,$this->data);}return$this->data;}function offsetGet($x){if(isset($this->data[$x])){return$this->data[$x];}}function offsetSet($x,&$WB){$this->data[$x]=$WB;return$this;}}defined('CACHE_UNLINK_EMPTY_FREQ')or define('CACHE_UNLINK_EMPTY_FREQ',0.2);class DOCX_Directory{const ATTR_FILE_MTIME='mtime';const ATTR_FILE_MD5='md5';const ATTR_FILE_SHA='sha';const ATTR_FILE_SIZE='size';var$dir='';var$extname=false;var$files=array();var$order_prefixes=array();var$order_attr='';var$order_desc=false;protected$attr_cmp='';protected$changed=false;function __construct($J='.',$AB=false,$S=self::ATTR_FILE_MTIME){$J=realpath($J);if(is_dir($J)){$this->dir=$J;$this->extname=$AB;}$this->attr_cmp=$S;}static function removeEmpty($B,$eB=CACHE_UNLINK_EMPTY_FREQ){if(!file_exists($B)){return 0;}$h=0;if($eB>=1||$eB>=mt_rand(1,10000)/10000){$F=scandir($B);if(is_array($F)&&count($F)===2){if($F[0]==='.'&&$F[1]==='..'){@rmdir($B);$h++;}}}return$h;}static function removeAll($B,array$a=array()){if(!file_exists($B)){return 0;}$h=0;$SC=scandir($B);foreach($SC as$Q){if($a&&in_array($Q,$a)){continue;}$XB=rtrim($B,DIRECTORY_SEPARATOR).DIRECTORY_SEPARATOR.$Q;if(is_dir($XB)){if($Q==='.'||$Q==='..'){continue;}self::removeAll($XB);}else{unlink($XB);$h++;}}if(!in_array('.',$a)){rmdir($B);}return$h;}static function eraseOrd($L,$SB='_',$w=false){$L=$w?basename($L,$w):basename($L);$K=explode($SB,$L,2);if(count($K)===2&&is_numeric($K[0])){return$K[1];}return$L;}static function getAttrFunc($S){switch($S){case self::ATTR_FILE_MD5:return'md5_file';case self::ATTR_FILE_SHA:return'sha1_file';case self::ATTR_FILE_SIZE:return'filesize';case self::ATTR_FILE_MTIME:default:return'filemtime';}}static function sortFiles(array&$F,$S,$bB=false){if(in_array($S,array(self::ATTR_FILE_SIZE,self::ATTR_FILE_MTIME))){$zB='return $a["'.$S.'"] - $b["'.$S.'"];';}else{$zB='return strcasecmp($a["'.$S.'"], $b["'.$S.'"]);';}$TC=$bB?'$b, $a':'$a, $b';uasort($F,create_function($TC,$zB));}function sortSubDir($r){if(empty($this->order_prefixes)||empty($this->order_attr)){return;}$UC=ltrim($r,'.');foreach($this->order_prefixes as$d){if(starts_with($UC,$d)){self::sortFiles($this->files[$r],$this->order_attr,$this->order_desc);}}}function setSorting(array$wB,$nB,$bB=false){if($wB&&$nB===$this->attr_cmp){$this->order_prefixes=$wB;$this->order_attr=$nB;$this->order_desc=$bB;}return$this;}function addCache($cB){$c=new DOCX_Cache($cB);$c->connect($this->files)->load($this->changed);return$this;}function scan(array&$F,$J,$d='.'){$rB=scandir($J);if(version_compare(PHP_VERSION,'5.4.0')<0){sort($rB);}foreach($rB as$s){if(substr($s,0,1)==='.'){continue;}$Q=$J.DIRECTORY_SEPARATOR.$s;$AB='.'.pathinfo($s,PATHINFO_EXTENSION);$sB=self::eraseOrd($s,'_',$this->extname?$this->extname:$AB);if(is_dir($Q)){$uB=$d.'/'.$sB;$F[$uB]=array();$this->scan($F,$Q,$uB);}else if($this->extname===false||$this->extname===$AB){$VC=self::getAttrFunc($this->attr_cmp);$F[$d][$sB]=array('fname'=>$Q,$this->attr_cmp=>$VC($Q),);}}return$this;}function getFiles(){if(empty($this->files)){$this->scan($this->files,$this->dir);if($this->order_prefixes&&$this->order_attr){foreach($this->files as$r){$this->sortSubDir($r);}}}return$this->files;}function getDiffs(){$VB=array();$this->scan($VB,$this->dir);$M=array('deldirs'=>array(),'delfiles'=>array(),'addfiles'=>array(),'modfiles'=>array());$M['deldirs']=array_diff(array_keys($this->files),array_keys($VB));if(!empty($M['deldirs'])){foreach($M['deldirs']as$B){unset($this->files[$B]);}$this->changed=true;}foreach($VB as$B=>&$F){$GB=isset($this->files[$B])?$this->files[$B]:array();if($IB=array_diff(array_keys($GB),array_keys($F))){$M['delfiles'][$B]=$IB;if(!empty($IB)){foreach($IB as$G){unset($this->files[$B][$G]);}$this->changed=true;}}$PB=array();$FB=array();foreach($F as$G=>&$EB){if(!isset($GB[$G])){$PB[]=$G;$this->files[$B][$G]=&$EB;}else if($EB[$this->attr_cmp]!==$GB[$G][$this->attr_cmp]){$FB[]=$G;$this->files[$B][$G]=&$EB;}}if(!empty($PB)){$M['addfiles'][$B]=$PB;$this->changed=true;}if(!empty($FB)){$M['modfiles'][$B]=$FB;$this->changed=true;}$this->sortSubDir($B);}return$M;}}defined('CACHE_DIR_MODE')or define('CACHE_DIR_MODE',0755);defined('CACHE_FILE_MODE')or define('CACHE_FILE_MODE',0666);class DOCX_FileKeeper{var$csv_delimiter=",";protected$extname=false;protected function prepare($D,$WC=false){assert(is_string($D));if($WC&&!is_file($D)){try{@mkdir(dirname($D),CACHE_DIR_MODE,true);@touch($D);@chmod($D,CACHE_FILE_MODE);}catch(\Exception$mC){return false;}}if($this->extname===false){$this->extname=pathinfo($D,PATHINFO_EXTENSION);}return$D;}function read($D,$XC=null){$C=null;if($D=$this->prepare($D,true)){$oB='_read'.$this->extname;if(method_exists($this,$oB)){$C=$this->$oB($D);}else{$C=$this->_read($D);}}return(is_null($C)||$C===false)?$XC:$C;}function write($D,&$C,$YC=0){if($D=$this->prepare($D,true)){$pB='_write'.$this->extname;if(method_exists($this,$pB)){return$this->$pB($D,$C);}else{return$this->_write($D,$C);}}}function delete($D){if($D=$this->prepare($D,false)){unlink($D);DOCX_Directory::unlinkEmpty(dirname($D));}}protected function _read($D){if($C=file_get_contents($D)){$xB='_unformat'.$this->extname;if(method_exists($this,$xB)){return$this->$xB($C);}else{return$C;}}}protected function _write($D,&$C,$YC=0){$j='_format'.$this->extname;if(method_exists($this,$j)){$I=$this->$j($C);}else{$I=$C;}return file_put_contents($D,$I,LOCK_EX);}protected function _readPHP($D){if(filesize($D)>0){return(include$D);}}protected function _formatPHP(&$C){return"<?php \nreturn ".var_export($C,true).";\n";}protected function _readCSV($D){$C=array();if(($N=fopen($D,'rb'))!==false){while(($MB=fgetcsv($N,0,$this->csv_delimiter))!==false){$C[]=$MB;}fclose($N);}return$C;}protected function _writeCSV($D,&$C){$yB=0;if(($N=fopen($D,'wb'))!==false){foreach($C as$MB){$yB+=fputcsv($N,$MB,$this->csv_delimiter);}fclose($N);}return$yB;}protected function _formatJSON(&$C){return json_encode($C);}protected function _unformatJSON(&$C){return json_decode($C,true);}protected function _formatYAML(&$C){if(extension_loaded('yaml')){return yaml_emit($C,YAML_UTF8_ENCODING,YAML_LN_BREAK);}else if(class_exists('Yaml\\Dumper',true)){$PC=new Yaml\Dumper();return$PC->dump($C);}}protected function _unformatYAML(&$C){if(extension_loaded('yaml')){return yaml_parse($C);}else if(class_exists('Yaml\\Parser',true)){$QC=new Yaml\Parser();return$QC->parse($C);}}}class DOCX_Markdoc{static$meta_keys=array('layout','date','created','title','slug','author','category','tags','comments');protected static$instances=array();protected$metadata=array();protected$filename='';protected$dochtml='';protected$markdown='';protected$metatext='';protected$headsize=-1;protected function __construct($e){$this->filename=$e;}static function getInstance($e){if(!isset(self::$instances[$e])){self::$instances[$e]=new self($e);}return self::$instances[$e];}static function parseMetaLine($H){$K=explode(':',$H);if(count($K)===2){$K[0]=strtolower(trim($K[0]));if(in_array($K[0],self::$meta_keys,true)){$K[1]=trim($K[1]);return$K;}}}function normalizeMetaData(array&$A){if(!isset($A['title'])){$A['title']=clean_ord($this->filename);}if(!isset($A['author'])){$A['author']='';}if(isset($A['tags'])&&is_string($A['tags'])){$A['tags']=array_map('trim',explode(',',$A['tags']));}if(!isset($A['date'])){$A['date']=filemtime($this->filename);}else if(!is_numeric($A['date'])){$A['date']=strtotime($A['date']);}return$this->metadata=&$A;}function parseMetaData($RC=false){if(!is_readable($this->filename)){$this->metadata=array('title'=>'Oh No');$this->dochtml='<h3>抱歉，找不到页面~!</h3>';$this->headsize=0;return$this->metadata;}$this->metatext='';$A=array();$N=fopen($this->filename,'rb');if($N===false){return false;}$H=fgets($N);$H=$H?trim($H):'';$H=preg_replace('{^\xEF\xBB\xBF|\x1A}','',$H);while(!$H||!trim($H));$KB=0;while($p=strlen($H)){$this->metatext.=$H."\n";if($p>=3&&$H===str_repeat('-',$p)){if($KB<=0){$KB=$p;}else if($KB===$p){$H='';break;}}else if($mB=self::parseMetaLine($H)){$A[$mB[0]]=$mB[1];}else{break;}$H=fgets($N);$H=$H?trim($H):'';}if($RC){$this->markdown=$H.fread($N,filesize($this->filename));$this->headsize=0;}else{$this->markdown=$H;$this->headsize=ftell($N);}fclose($N);$this->metatext=trim($this->metatext);return$this->normalizeMetaData($A);}function getMetaData($NB=false){if($this->headsize<0){$this->parseMetaData(false);}if($NB===false){return$this->metadata;}else if(isset($this->metadata[$NB])){return$this->metadata[$NB];}}function getPageData(){$this->getMetaData(false);if($this->headsize>0||!$this->markdown){$I=file_get_contents($this->filename);$this->markdown=substr($I,$this->headsize);$this->headsize=0;}if(!$this->dochtml&&$this->markdown){$this->dochtml=Parsedown::instance()->text($this->markdown);}$ZC=array('metatext'=>$this->metatext,'markdown'=>$this->markdown,'dochtml'=>$this->dochtml,);return array_merge($this->metadata,$ZC);}function update($aC,$hC){$I=$aC."\n\n".$hC;file_put_contents($this->filename,$I,LOCK_EX);$this->parseMetaData(true);return$this;}}class DOCX_Templater{var$caches=array();var$globals=array();protected$source_dir='';protected$cache_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';protected$current_file='';protected$current_cache=null;function __construct($CB,$iC=''){if($CB){$this->setSourceDir($CB);}$this->cache_dir=rtrim($iC,' /\\');}static function replaceWith($I,array$b=array(),$d='',$jC=''){if(!empty($b)){$lB=array();$kB=array();foreach($b as$P=>&$WB){$lB[]=$d.$P.$jC;$kB[]=$WB;}$I=str_replace($lB,$kB,$I);}return$I;}function setSourceDir($CB){$this->source_dir=rtrim($CB,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function addCache($_,&$I){if(!isset($this->caches[$_])){$c=new DOCX_Cache($this->cache_dir.DIRECTORY_SEPARATOR.$_);$this->caches[$_]=&$c;}else{$c=&$this->caches[$_];}$c->connect($I)->load();return$c;}function updateGlobals(array$OC){$this->globals=array_merge($this->globals,$OC);}function prepareFile($X){return$this->source_dir.'/'.$X;}function render($X,array$b=array(),$fB=false){$this->current_file=$X;if($fB){ob_start();}extract($this->globals);extract($b);include$this->prepareFile($this->current_file);if(!empty($this->extend_files)){$kC=array_pop($this->extend_files);foreach($this->extend_files as$G){include$this->prepareFile($G);}extract($this->template_blocks);include$this->prepareFile($kC);}if($fB){$M=ob_get_clean();return$M?trim($M):'';}}function extendTpl($X){array_push($this->extend_files,$X);}function includeTpl($X,array$b=array(),$gC=false){extract($this->globals);extract($b);include$this->prepareFile($X);}function blockStart($fC='content',$gC=false){$this->current_block=$fC;ob_start();}function blockEnd(){$bC=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$bC;}}class DOCX_View{const URL_PRE='{{DOCX_URL_PRE}}';const URL_EXT='{{DOCX_URL_EXT}}';const URL_ASSETS='{{DOCX_URL_ASSETS}}';const HTML_HIDE='{{DOCX_HTML_HIDDEN}}';protected$app=null;protected$metadata=array();protected$tpl_file='';protected$content=false;protected$replacers=array();protected$templater=null;function __construct($cC,array&$A,$O='',$V=false){$this->app=$cC;$this->metadata=$A;$this->tpl_file=$this->getTplFile($O,$V);}static function isPost(){return strtoupper($_SERVER['REQUEST_METHOD'])==='POST';}function getTplFile($O,$V=false){if(empty($O)){if(isset($this->metadata['layout'])){$O=$this->metadata['layout'];}if(empty($O)){$O=$this->app->getOption('layout');}$O=($V?'edit/':'').$O.'.php';}return is_readable($this->app->theme_dir.'/'.$O)?$O:'base.php';}function isEditMode(){return starts_with($this->tpl_file,'edit/');}function ensureAssets($k=false){if($k===false){$k=$this->app->public_dir;}$Z=$k.'/assets';if(!file_exists($Z)){$eC=strtoupper(substr(PHP_OS,0,3))==='WIN'?'xcopy':'cp -r';if(realpath($Z)!==$this->app->assets_dir){@shell_exec($eC.' '.$this->app->assets_dir.' '.$Z);}}}function getTemplater(){if(is_null($this->templater)){$YB=$this->app->getDocsDir();$this->templater=new DOCX_Templater($this->app->theme_dir,$this->app->cache_dir);$this->templater->globals=array('home_url'=>$this->app->getConstant('HOME_PAGE_URL'),'admin_urlpre'=>$this->app->getConstant('ADMIN_URLPRE'),'url_join'=>$this->app->getURLJoin(),'html_hide'=>self::HTML_HIDE,'options'=>$this->app->getOption(false),'docs'=>&$YB->files,);$this->ensureAssets($this->app->public_dir);}return$this->templater;}function renderPage(){if($this->content!==false){return;}$y=DOCX_Markdoc::getInstance($this->metadata['fname']);if(self::isPost()){$y->update($_POST['metatext'],trim($_POST['markdown']));}$hB='';if($this->metadata['url']===$this->app->getConstant('HOME_PAGE_URL')){$hB=$this->app->getToppestPage();}$u=$this->getTemplater();$u->globals['urlpre']=self::URL_PRE;$u->globals['urlext']=self::URL_EXT;$u->globals['assets_url']=self::URL_ASSETS;$this->content=$u->render($this->tpl_file,array('view'=>&$this,'page'=>$y->getPageData(),'curr_url'=>$this->metadata['url'],'first_page_url'=>$hB,),true);}function output(){$this->renderPage();$R=$this->app->getOption('urlext_php');$this->replacers[self::URL_EXT]=$R;$this->replacers[self::HTML_HIDE]='{}';$t=$this->app->getRelPrefix();$lC=$this->app->getOption('assets_dir');$this->replacers[self::URL_PRE]=$this->app->getAbsPrefix();$this->replacers[self::URL_ASSETS]=$t.'/assets';$I=DOCX_Templater::replaceWith($this->content,$this->replacers);@header('Content-Type: text/html; charset=utf8');return die($I);}function getStaticContent(){$this->renderPage();$R=$this->app->getOption('urlext_html');$this->replacers[self::URL_EXT]=$R;$this->replacers[self::HTML_HIDE]='{display: none}';$E=$this->metadata['url'].$R;$t=$this->app->getRelPrefix(ltrim($E,'/'));$this->replacers[self::URL_PRE]=$t;$this->replacers[self::URL_ASSETS]=$t.'/assets';return DOCX_Templater::replaceWith($this->content,$this->replacers);}function staticize($f=false){$k=$this->app->public_dir;if($f===false){$f=$k.$this->metadata['url'].$R;}@mkdir(dirname($f),0755,true);$I=$this->getStaticContent();return file_put_contents($f,$I,LOCK_EX);}}defined('APP_ROOT')or die('Illeigal access');function autoload_class($BB){if(substr($BB,0,5)==='DOCX_'){$J='DocX/'.substr($BB,5).'.php';}else{$J=$BB.'.php';}require_once DOCX_ROOT.'/library/'.$J;return class_exists($BB,false);}function starts_with($DB,$l){return strncmp($DB,$l,strlen($l))===0;}function ends_with($DB,$l){$LB=strlen($l);return$LB===0||(strlen($DB)>=$LB&&substr_compare($DB,$l,-$LB)===0);}function convert($o,$g='UTF-8'){$g=strtoupper($g);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($o,$g,true)?$o:mb_convert_encoding($o,$g,'UTF-8, GBK');}else if(function_exists('iconv')){$LC=$g==='UTF-8'?'GBK':'UTF-8';return iconv($LC,$g.'//IGNORE',$o);}}function http_redirect($MC='',$IC=false){$JC=$IC?301:302;@header('Location: '.$MC,true,$JC);return die();}function compare_pathes($T,$U){if($T===$U){return array($T,0,0);}else if(starts_with($T,$U)){$CC=substr_count(substr($T,strlen($U)),'/');return array($U,0,$CC);}else if(starts_with($U,$T)){$EC=substr_count(substr($U,strlen($T)),'/');return array($T,$EC,0);}$qB=explode('/',$U);$JB=explode('/',$T);$_B=count($qB);foreach($JB as$i=>$NC){if($i>=$_B||$NC!==$qB[$i]){$KC=implode('/',array_slice($JB,0,$i));return array($KC,$_B-$i,count($JB)-$i);}}return array('',-1,-1);}function clean_ord($L,$w='.md',$SB='_'){$L=basename($L,$w);$K=explode($SB,$L,2);if(count($K)===2&&is_numeric($K[0])){return$K[1];}return$L;}function slugify($L){return strtolower(str_replace(' ','-',$L));}function rand_greeting($OB){static$HB=0;if($HB===0){shuffle($OB);$HB=count($OB);}return$OB[--$HB];}function zh_date($j,$AC=false){$M=date($j,$AC);if(strpos($j,'星期w')!==false){$tB=array('星期0'=>'星期日','星期1'=>'星期一','星期2'=>'星期二','星期3'=>'星期三','星期4'=>'星期四','星期5'=>'星期五','星期6'=>'星期六');$M=str_replace(array_keys($tB),array_values($tB),$M);}return$M;}